<app-header
  [title]="'Outline Overview'"
  [leftActions]="leftActions"
  [rightActions]="rightActions"
  [showBurgerMenu]="false"
></app-header>

<ion-content [fullscreen]="true">
  @if (story(); as s) {
    <div class="story-meta">
      <div class="title">{{ s.title || 'Untitled Story' }}</div>
      <div class="meta">
        {{ s.chapters.length || 0 }} chapter(s)
        @if (query()) {
          <span class="filter-info"> â€¢ Filtering: "{{ query() }}"</span>
        }
      </div>
    </div>
  }

  @if (loading()) {
    <div class="loading">
      <ion-skeleton-text [animated]="true" style="width: 60%; height: 20px;"></ion-skeleton-text>
      <ion-skeleton-text [animated]="true" style="width: 90%; height: 16px;"></ion-skeleton-text>
      <ion-skeleton-text [animated]="true" style="width: 80%; height: 16px;"></ion-skeleton-text>
    </div>
  }

  @if (!loading()) {
    <ion-accordion-group [multiple]="true" [value]="expandedArray()" (ionChange)="onAccordionChange($event)">
      @for (chapter of filteredChapters(); track chapter.id) {
        <ion-accordion [value]="chapter.id">
          <ion-item slot="header" lines="full">
            <app-chapter-header
              [chapter]="chapter"
              [saving]="isSavingChapter(chapter.id)"
              (titleUpdate)="onChapterTitleUpdate($event)">
            </app-chapter-header>
          </ion-item>
          <div class="chapter-content" slot="content">
            <ion-list lines="none">
              @for (scene of chapter.scenes; track scene.id) {
                <app-scene-card
                  [scene]="scene"
                  [chapterId]="chapter.id"
                  [wordCount]="getSceneWordCount(scene.id)"
                  [selectedModel]="selectedModel"
                  [generatingSummary]="isGeneratingSummary(scene.id)"
                  [generatingTitle]="isGeneratingTitle(scene.id)"
                  [savingSummary]="isSavingScene(scene.id)"
                  [savingTitle]="isSavingScene(scene.id)"
                  (update)="onSceneUpdate($event)"
                  (generateAI)="onSceneAIGenerate($event)"
                  (openScene)="onSceneNavigate($event)">
                </app-scene-card>
              }
            </ion-list>
          </div>
        </ion-accordion>
      }
    </ion-accordion-group>
  }

  @if (!loading() && filteredChapters().length === 0) {
    <div class="empty">
      <p>No scenes match your filter.</p>
    </div>
  }
</ion-content>

<!-- Bottom Tools Bar -->
<div class="tools-bar tools-bar--bottom">
  <div class="tools-bar__search">
    <ion-searchbar
      #searchbar
      placeholder="Search titles and summaries..."
      [debounce]="150"
      [value]="query()"
      (ionInput)="query.set($any($event.target).value || '')"
      (ionClear)="query.set('')">
    </ion-searchbar>
  </div>
  <div class="tools-bar__actions">
    <app-model-selector
      [(model)]="selectedModel"
      [quickPickIds]="sceneSummaryFavorites"
      [placeholder]="'AI Model'"
      [appendTo]="'body'"
      class="model-selector-compact">
    </app-model-selector>
    <ion-button
      size="small"
      fill="outline"
      color="medium"
      (click)="copyAllSummaries()"
      title="Copy all summaries to clipboard"
      class="copy-btn">
      <ion-icon name="copy-outline" slot="start"></ion-icon>
      <span class="btn-text">Copy All</span>
    </ion-button>
  </div>
</div>
