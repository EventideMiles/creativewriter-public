<div class="story-structure" role="navigation" aria-label="Story structure">
  <div class="structure-header">
    <h2>Structure</h2>
    <ion-button
      fill="clear"
      size="small"
      class="close-button cw-btn-icon"
      (click)="onCloseSidebar()"
      aria-label="Close sidebar">
      <ion-icon name="close" slot="icon-only"></ion-icon>
    </ion-button>
  </div>
  
  <ion-content class="structure-content" [scrollEvents]="true">
    <div id="add-chapter-help" class="sr-only">
      Adds a new chapter to the story
    </div>
    
    <div class="structure-actions">
      <ion-button
        expand="block"
        fill="outline"
        class="add-chapter-btn cw-btn-primary"
        (click)="addChapter()"
        aria-label="Add new chapter">
        <ion-icon name="add" slot="start" [attr.aria-hidden]="true"></ion-icon>
        New Chapter
      </ion-button>
    </div>
    
    <ion-list class="chapters-list" role="tree" aria-label="Chapters and Scenes">
      <div *ngFor="let chapter of story.chapters; trackBy: trackChapter" 
           class="chapter-item">
        
        <ion-item 
          button 
          detail="false" 
          (click)="toggleChapter(chapter.id)" 
          (keydown)="onChapterKeyDown($event, chapter.id)"
          class="chapter-header"
          role="treeitem"
          tabindex="0"
          [attr.aria-expanded]="expandedChapters.has(chapter.id)"
          [attr.aria-label]="'Chapter: ' + (chapter.title || 'Untitled') + '. ' + (expandedChapters.has(chapter.id) ? 'Expanded' : 'Collapsed')">
          <ion-icon 
            [name]="expandedChapters.has(chapter.id) ? 'chevron-down' : 'chevron-forward'" 
            slot="start" 
            class="expand-icon"
            (click)="toggleChapter(chapter.id); $event.stopPropagation()"
            [attr.aria-hidden]="true">
          </ion-icon>
          <div class="chapter-title-container">
            <div class="chapter-id-display">{{ 'C' + (chapter.chapterNumber || chapter.order) }}</div>
            <ion-label class="chapter-title">{{ chapter.title || 'Chapter Title' }}</ion-label>
          </div>
          <ion-button
            fill="clear"
            class="delete-btn cw-btn-icon-danger"
            slot="end"
            (click)="deleteChapter(chapter.id, $event)"
            [attr.aria-label]="'Delete chapter: ' + (chapter.title || 'Untitled')">
            <ion-icon name="trash" slot="icon-only" [attr.aria-hidden]="true"></ion-icon>
          </ion-button>
        </ion-item>
        
        <div class="scenes-list" *ngIf="expandedChapters.has(chapter.id)" role="group" [attr.aria-label]="'Scenes in chapter: ' + (chapter.title || 'Untitled')">
          <ion-list role="none">
            <ng-container *ngFor="let scene of chapter.scenes; trackBy: trackScene">
              <ion-item 
                button
                detail="false"
                [class.active-scene]="isActiveScene(chapter.id, scene.id)"
                (click)="selectScene(chapter.id, scene.id)"
                (keydown)="onSceneKeyDown($event, chapter.id, scene.id)"
                class="scene-item"
                role="treeitem"
                tabindex="0"
                [attr.aria-selected]="isActiveScene(chapter.id, scene.id)"
                [attr.aria-label]="'Scene: ' + (scene.title || 'Untitled') + '. ' + (getWordCount(scene)) + ' words' + (isActiveScene(chapter.id, scene.id) ? '. Currently selected' : '')">
                
                <div class="scene-content">
                  <div class="scene-id-display">{{ 'C' + (chapter.chapterNumber || chapter.order) + 'S' + (scene.sceneNumber || scene.order) }}</div>
                  <div class="scene-title-container">
                    <ion-label class="scene-title-display">{{ scene.title || 'Scene Title' }}</ion-label>
                  </div>
                  <span class="word-count-badge">{{ getWordCount(scene) }}w</span>
                  <ion-button
                    fill="clear"
                    size="small"
                    class="delete-btn cw-btn-icon-danger"
                    (click)="deleteScene(chapter.id, scene.id, $event)"
                    [attr.aria-label]="'Delete scene: ' + (scene.title || 'Untitled')"
                    (touchstart)="$event.stopPropagation()"
                    (touchend)="$event.stopPropagation()">
                    <ion-icon name="trash" slot="icon-only" [attr.aria-hidden]="true"></ion-icon>
                  </ion-button>
                </div>
              </ion-item>
            </ng-container>
          </ion-list>
          
          <ion-button
            expand="block"
            fill="outline"
            class="add-scene-btn cw-btn-secondary"
            (click)="addScene(chapter.id)"
            [attr.aria-label]="'Add new scene to chapter: ' + (chapter.title || 'Untitled')">
            <ion-icon name="add" slot="start" [attr.aria-hidden]="true"></ion-icon>
            New Scene
          </ion-button>
        </div>
      </div>
    </ion-list>
  </ion-content>
</div>
