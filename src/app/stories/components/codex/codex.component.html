    <div class="ion-page">
      <!-- Header -->
      <app-header 
        title="Codex" 
        [showBackButton]="true"
        [backAction]="goBack.bind(this)"
        [rightActions]="headerActions"
        [showSecondaryToolbar]="true"
        [secondaryContent]="searchToolbar">
      </app-header>
      
      <ng-template #searchToolbar>
        <ion-searchbar
          placeholder="Search by title, content, or tags..."
          [(ngModel)]="searchQuery"
          (ionInput)="onSearch()"
          debounce="300">
        </ion-searchbar>
      </ng-template>

      <!-- Content -->
      <ion-content>
        <!-- Help Card for Transfer Feature -->
        <ion-card *ngIf="showHelpCard()" class="help-card">
          <ion-card-header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <ion-icon name="help-circle" color="primary" style="font-size: 1.5rem;"></ion-icon>
                <ion-card-title>Transfer Codex Entries</ion-card-title>
              </div>
              <ion-button fill="clear" size="small" (click)="dismissHelpCard()">
                <ion-icon name="close" slot="icon-only"></ion-icon>
              </ion-button>
            </div>
          </ion-card-header>
          <ion-card-content>
            <p><strong>New Feature!</strong> You can now transfer Codex entries between stories.</p>
            <div class="help-steps">
              <div class="help-step">
                <ion-icon name="swap-horizontal" color="primary"></ion-icon>
                <div>
                  <strong>Step 1:</strong> Click the <strong>Transfer</strong> button in the header
                </div>
              </div>
              <div class="help-step">
                <ion-icon name="checkmark-circle" color="success"></ion-icon>
                <div>
                  <strong>Step 2:</strong> Select source and destination stories
                </div>
              </div>
              <div class="help-step">
                <ion-icon name="list" color="medium"></ion-icon>
                <div>
                  <strong>Step 3:</strong> Choose which entries to transfer
                </div>
              </div>
              <div class="help-step">
                <ion-icon name="checkmark-done" color="success"></ion-icon>
                <div>
                  <strong>Step 4:</strong> Review and confirm the transfer
                </div>
              </div>
            </div>
            <ion-note color="medium">
              <ion-icon name="information-circle"></ion-icon>
              Entries are copied to the destination story. Categories are created automatically if needed. Duplicate entries get a numbered suffix.
            </ion-note>
          </ion-card-content>
        </ion-card>

        <ion-grid class="codex-grid">
          <ion-row>
            <!-- Sidebar with categories -->
            <ion-col size="12" size-md="3" class="categories-sidebar">
              <ion-card>
                <ion-card-header>
                  <ion-card-title>Categories</ion-card-title>
                </ion-card-header>
                <ion-card-content>
                  <ion-list>
                    <ion-item 
                      *ngFor="let category of sortedCategories()" 
                      button
                      [class.active-category]="selectedCategoryId() === category.id"
                      (click)="selectCategory(category.id)">
                      <ion-icon [name]="getDefaultIcon()" slot="start"></ion-icon>
                      <ion-label>
                        <h3>{{ category.icon }} {{ category.title }}</h3>
                        <p>{{ category.entries.length }} entries</p>
                      </ion-label>
                      <ion-button 
                        fill="clear" 
                        size="small"
                        (click)="$event.stopPropagation(); toggleCategoryMenu(category.id)"
                        slot="end">
                        <ion-icon name="ellipsis-vertical" slot="icon-only"></ion-icon>
                      </ion-button>
                      
                      <!-- Category menu -->
                      <ion-list *ngIf="categoryMenuId() === category.id" class="category-menu">
                        <ion-item button (click)="editCategory()">
                          <ion-icon name="create" slot="start"></ion-icon>
                          <ion-label>Edit</ion-label>
                        </ion-item>
                        <ion-item button (click)="deleteCategory(category.id)" color="danger">
                          <ion-icon name="trash" slot="start"></ion-icon>
                          <ion-label>Delete</ion-label>
                        </ion-item>
                      </ion-list>
                    </ion-item>
                  </ion-list>
                </ion-card-content>
              </ion-card>
            </ion-col>

            <!-- Main content area -->
            <ion-col size="12" size-md="9" class="entries-main">
              <div *ngIf="searchQuery(); else normalView">
                <ion-card>
                  <ion-card-header>
                    <ion-card-title>Search results for "{{ searchQuery() }}"</ion-card-title>
                  </ion-card-header>
                  <ion-card-content>
                    <ion-grid>
                      <ion-row>
                        <ion-col *ngFor="let entry of searchResults()" size="12" size-md="6" size-lg="4">
                          <ion-card button (click)="selectEntry(entry)" class="entry-card">
                            <ion-card-header>
                              <div class="entry-header-with-thumbnail">
                                <div class="entry-thumbnail" *ngIf="getPortraitSrc(entry)">
                                  <img [src]="getPortraitSrc(entry)" [alt]="entry.title">
                                </div>
                                <div class="entry-thumbnail placeholder" *ngIf="!getPortraitSrc(entry)">
                                  <ion-icon name="person-outline"></ion-icon>
                                </div>
                                <div class="entry-title-area">
                                  <ion-card-title>{{ entry.title }}</ion-card-title>
                                </div>
                              </div>
                            </ion-card-header>
                            <ion-card-content>
                              <ion-text color="medium">
                                <p>{{ getContentPreview(entry.content) }}</p>
                              </ion-text>
                              <div class="entry-meta">
                                <ion-chip color="primary">
                                  <ion-label>{{ getCategoryName(entry.categoryId) }}</ion-label>
                                </ion-chip>
                                <ion-chip *ngIf="entry.alwaysInclude" color="warning">
                                  <ion-icon name="star"></ion-icon>
                                  <ion-label>Always included</ion-label>
                                </ion-chip>
                                <ion-chip *ngIf="entry.metadata?.['storyRole']" color="success">
                                  <ion-icon name="person"></ion-icon>
                                  <ion-label>{{ entry.metadata?.['storyRole'] }}</ion-label>
                                </ion-chip>
                                <ion-chip *ngFor="let tag of entry.tags" color="medium">
                                  <ion-icon name="pricetag"></ion-icon>
                                  <ion-label>{{ tag }}</ion-label>
                                </ion-chip>
                              </div>
                            </ion-card-content>
                          </ion-card>
                        </ion-col>
                      </ion-row>
                    </ion-grid>
                  </ion-card-content>
                </ion-card>
              </div>

              <ng-template #normalView>
                <div *ngIf="selectedCategory(); else selectCategoryPrompt">
                  <ion-card>
                    <ion-card-header>
                      <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                        <ion-card-title>
                          {{ selectedCategory()!.icon }} {{ selectedCategory()!.title }}
                        </ion-card-title>
                        <ion-button 
                          fill="outline" 
                          size="small" 
                          (click)="createNewEntry()">
                          <ion-icon name="add" slot="start"></ion-icon>
                          Add Entry
                        </ion-button>
                      </div>
                    </ion-card-header>
                    <ion-card-content>
                      <ion-grid>
                        <ion-row>
                          <ion-col 
                            *ngFor="let entry of sortedEntries()" 
                            size="12" 
                            size-md="6" 
                            size-lg="4">
                            <ion-card button (click)="selectEntry(entry)" class="entry-card">
                              <ion-card-header>
                                <div class="entry-header-with-thumbnail">
                                  <div class="entry-thumbnail" *ngIf="getPortraitSrc(entry)">
                                    <img [src]="getPortraitSrc(entry)" [alt]="entry.title">
                                  </div>
                                  <div class="entry-thumbnail placeholder" *ngIf="!getPortraitSrc(entry)">
                                    <ion-icon name="person-outline"></ion-icon>
                                  </div>
                                  <div class="entry-title-area">
                                    <ion-card-title>{{ entry.title }}</ion-card-title>
                                  </div>
                                </div>
                              </ion-card-header>
                              <ion-card-content>
                                <ion-text color="medium">
                                  <p>{{ getContentPreview(entry.content) }}</p>
                                </ion-text>
                                <div class="entry-meta">
                                  <ion-chip *ngIf="entry.alwaysInclude" color="warning">
                                    <ion-icon name="star"></ion-icon>
                                    <ion-label>Always included</ion-label>
                                  </ion-chip>
                                  <ion-chip *ngIf="entry.metadata?.['storyRole']" color="success">
                                    <ion-icon name="person"></ion-icon>
                                    <ion-label>{{ entry.metadata?.['storyRole'] }}</ion-label>
                                  </ion-chip>
                                  <ion-chip *ngFor="let tag of entry.tags" color="medium">
                                    <ion-icon name="pricetag"></ion-icon>
                                    <ion-label>{{ tag }}</ion-label>
                                  </ion-chip>
                                  <ion-note>{{ formatDate(entry.updatedAt) }}</ion-note>
                                </div>
                              </ion-card-content>
                            </ion-card>
                          </ion-col>
                        </ion-row>
                      </ion-grid>
                    </ion-card-content>
                  </ion-card>
                </div>
              </ng-template>

              <ng-template #selectCategoryPrompt>
                <ion-card>
                  <ion-card-content class="ion-text-center">
                    <ion-text color="medium">
                      <h2>Choose a category</h2>
                      <p>Choose a category from the sidebar to see the entries.</p>
                    </ion-text>
                  </ion-card-content>
                </ion-card>
              </ng-template>
            </ion-col>
          </ion-row>
        </ion-grid>
      </ion-content>

      <!-- Entry Modal -->
      <ion-modal [isOpen]="!!selectedEntry()" (didDismiss)="closeEntryModal()" class="entry-modal">
        <ng-template>
          <div class="entry-modal-page ion-page">
            <ion-header>
              <ion-toolbar>
                <ion-title>{{ editingEntry.title || 'Edit Entry' }}</ion-title>
                <ion-buttons slot="end">
                <ion-button (click)="closeEntryModal()">
                  <ion-icon name="close" slot="icon-only"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
            
            <ion-content class="entry-modal-content">
              <div class="modal-form-container">
              <!-- Basic Information Section -->
              <div class="form-section">
                <h3 class="section-title">Basic Information</h3>
                
                <div class="form-group">
                  <ion-item lines="none" class="form-item">
                    <ion-label position="stacked">Title <span class="required">*</span></ion-label>
                    <ion-input 
                      [(ngModel)]="editingEntry.title" 
                      placeholder="Enter title..."
                      type="text"
                      class="title-input">
                    </ion-input>
                  </ion-item>
                </div>

                <!-- Tags Section -->
                <div class="form-group">
                  <ion-item lines="none" class="form-item">
                    <ion-label position="stacked">Tags</ion-label>
                    <ion-input 
                      [(ngModel)]="tagInput" 
                      (ionBlur)="parseAndAddTags()"
                      placeholder="Enter tags (comma-separated)..."
                      class="tag-input">
                    </ion-input>
                  </ion-item>
                  <ion-note class="tag-help-text">
                    Tags for identification in Beat-AI (e.g. Combat, Romance, Conflict)
                  </ion-note>
                  <div class="tags-container" *ngIf="editingEntry.tags?.length">
                    <ion-chip 
                      *ngFor="let tag of editingEntry.tags" 
                      (click)="removeTag(tag)"
                      color="primary"
                      class="tag-chip">
                      <ion-label>{{ tag }}</ion-label>
                      <ion-icon name="close" size="small"></ion-icon>
                    </ion-chip>
                  </div>
                </div>
              </div>

              <!-- Portrait Section -->
              <div class="form-section">
                <h3 class="section-title">Portrait</h3>

                <!-- Portrait Gallery (horizontal thumbnail strip) -->
                <div class="portrait-gallery" *ngIf="editingEntry.portraitGallery?.length">
                  <div
                    *ngFor="let portrait of editingEntry.portraitGallery"
                    class="gallery-thumbnail"
                    [class.active]="portrait.id === editingEntry.activePortraitId"
                    (click)="selectPortrait(portrait.id)"
                    (keyup.enter)="selectPortrait(portrait.id)"
                    (keyup.space)="selectPortrait(portrait.id)"
                    tabindex="0"
                    role="button"
                    [attr.aria-label]="'Select portrait ' + (editingEntry.portraitGallery!.indexOf(portrait) + 1)"
                    [attr.aria-pressed]="portrait.id === editingEntry.activePortraitId">
                    <img
                      [src]="'data:image/jpeg;base64,' + portrait.base64"
                      alt="Portrait thumbnail">
                    <ion-button
                      fill="clear"
                      color="danger"
                      size="small"
                      class="remove-gallery-item-btn"
                      (click)="$event.stopPropagation(); removeGalleryPortrait(portrait.id)">
                      <ion-icon name="close-circle" slot="icon-only"></ion-icon>
                    </ion-button>
                    <div class="active-indicator" *ngIf="portrait.id === editingEntry.activePortraitId">
                      <ion-icon name="checkmark-circle"></ion-icon>
                    </div>
                  </div>
                </div>

                <!-- Active Portrait Large Preview -->
                <div class="portrait-preview" *ngIf="getActivePortraitBase64()">
                  <img
                    [src]="'data:image/jpeg;base64,' + getActivePortraitBase64()"
                    alt="Active Portrait">
                  <ion-button fill="clear" color="danger" size="small" (click)="removePortrait()" class="remove-portrait-btn" title="Clear all portraits">
                    <ion-icon name="trash" slot="icon-only"></ion-icon>
                  </ion-button>
                </div>

                <!-- Empty State -->
                <div class="portrait-empty" *ngIf="!editingEntry.portraitGallery?.length && !editingEntry.portraitBase64">
                  <ion-icon name="person-outline" class="empty-portrait-icon"></ion-icon>
                  <p>No portraits yet</p>
                </div>

                <!-- Gallery Info -->
                <ion-note *ngIf="editingEntry.portraitGallery?.length" color="medium" class="gallery-info">
                  <ion-icon name="images-outline"></ion-icon>
                  {{ editingEntry.portraitGallery!.length }}/5 portraits
                  <span *ngIf="editingEntry.portraitGallery!.length > 0"> - Click a thumbnail to set as active</span>
                </ion-note>

                <!-- Portrait Actions -->
                <div class="portrait-actions">
                  <!-- Generate Button (Characters Only, Premium) -->
                  <ion-button
                    *ngIf="isCharacterEntry()"
                    fill="outline"
                    size="small"
                    [disabled]="!canGeneratePortrait() || isGeneratingPortrait()"
                    (click)="generatePortrait()">
                    <ion-icon name="sparkles" slot="start"></ion-icon>
                    {{ isGeneratingPortrait() ? 'Generating...' : 'Generate Portrait' }}
                    <ion-spinner *ngIf="isGeneratingPortrait()" name="crescent" slot="end" style="margin-left: 8px;"></ion-spinner>
                  </ion-button>

                  <!-- Upload Button (All Users, All Entry Types) -->
                  <ion-button fill="outline" size="small" (click)="fileInput.click()" [disabled]="uploadingImage()">
                    <ion-icon name="cloud-upload" slot="start"></ion-icon>
                    {{ uploadingImage() ? 'Uploading...' : 'Upload Image' }}
                    <ion-spinner *ngIf="uploadingImage()" name="crescent" slot="end" style="margin-left: 8px;"></ion-spinner>
                  </ion-button>

                  <input #fileInput type="file" accept="image/*" (change)="uploadPortrait($event)" style="display: none;">
                </div>

                <!-- Info notes -->
                <ion-note *ngIf="isGalleryFull()" color="warning" class="portrait-info-note">
                  <ion-icon name="information-circle"></ion-icon>
                  Gallery is full (5 portraits). Oldest will be removed when adding new ones.
                </ion-note>

                <ion-note *ngIf="isCharacterEntry() && !portraitService.isOpenRouterConfigured()" color="warning" class="portrait-info-note">
                  <ion-icon name="information-circle"></ion-icon>
                  Configure OpenRouter in Settings to enable AI portrait generation
                </ion-note>
              </div>
                
              <!-- Story Role Section -->
              <div class="form-section" *ngIf="isCharacterEntry()">
                <h3 class="section-title">Story Settings</h3>
                
                <div class="form-group">
                  <ion-item lines="none" class="form-item">
                    <ion-label position="stacked">Story Role</ion-label>
                    <ion-select 
                      [(ngModel)]="editingEntry.storyRole"
                      placeholder="Select role..."
                      interface="popover"
                      class="role-select">
                      <ion-select-option value="">No Role</ion-select-option>
                      <ion-select-option 
                        *ngFor="let role of storyRoles" 
                        [value]="role.value">
                        {{ role.label }}
                      </ion-select-option>
                    </ion-select>
                  </ion-item>
                </div>
              </div>
              
              <!-- Always Include Section -->
              <div class="form-section">
                <h3 class="section-title">AI Settings</h3>
                
                <div class="form-group">
                  <ion-item lines="none" class="form-item">
                    <ion-label position="stacked">Always include in beat prompt</ion-label>
                    <ion-toggle 
                      [(ngModel)]="editingEntry.alwaysInclude"
                      slot="end"
                      color="primary">
                    </ion-toggle>
                  </ion-item>
                  <ion-note color="medium" style="padding: 0 16px; font-size: 0.9rem;">
                    When enabled, this entry will always be included in the beat prompt, regardless of relevance scoring.
                  </ion-note>
                </div>
              </div>
                
              <!-- Custom Fields Section -->
              <div class="form-section">
                <div class="section-header">
                  <h3 class="section-title">Custom Fields</h3>
                  <ion-button 
                    size="small" 
                    fill="outline" 
                    color="primary"
                    [disabled]="!newCustomFieldName.trim()"
                    (click)="addCustomField()">
                    <ion-icon name="add" slot="start"></ion-icon>
                    Add Field
                  </ion-button>
                </div>
                  
                <!-- Existing custom fields -->
                <div class="custom-fields-container">
                  <div *ngFor="let field of editingEntry.customFields" class="custom-field-item">
                    <div class="custom-field-header">
                      <ion-item lines="none" class="form-item field-name-item">
                        <ion-label position="stacked">Field Name</ion-label>
                        <ion-input 
                          [(ngModel)]="field.name" 
                          placeholder="Enter field name...">
                        </ion-input>
                      </ion-item>
                      <ion-button 
                        fill="clear" 
                        color="danger"
                        size="small"
                        (click)="removeCustomField(field.id)"
                        class="remove-field-btn">
                        <ion-icon name="trash" slot="icon-only"></ion-icon>
                      </ion-button>
                    </div>
                    <ion-item lines="none" class="form-item">
                      <ion-label position="stacked">Field Value</ion-label>
                    <ion-textarea 
                      [(ngModel)]="field.value" 
                      placeholder="Enter field value..."
                      rows="3"
                      [autoGrow]="true"
                      class="scrollable-textarea">
                    </ion-textarea>
                    </ion-item>
                  </div>
                  
                  <!-- Add new custom field form -->
                  <div class="new-custom-field">
                    <ion-item lines="none" class="form-item">
                      <ion-label position="stacked">New Field Name</ion-label>
                      <ion-input 
                        [(ngModel)]="newCustomFieldName" 
                        placeholder="Enter field name...">
                      </ion-input>
                    </ion-item>
                    <ion-item lines="none" class="form-item">
                      <ion-label position="stacked">Field Value</ion-label>
                    <ion-textarea 
                      [(ngModel)]="newCustomFieldValue" 
                      placeholder="Enter field value..."
                      rows="3"
                      [autoGrow]="true"
                      class="scrollable-textarea">
                    </ion-textarea>
                    </ion-item>
                  </div>
                </div>
              </div>
                
              <!-- Content Section -->
              <div class="form-section">
                <h3 class="section-title">Content</h3>
                
                <div class="form-group">
                  <ion-item lines="none" class="form-item content-item">
                    <ion-label position="stacked">Description</ion-label>
                    <ion-textarea 
                      [(ngModel)]="editingEntry.content" 
                      placeholder="Description, details, notes..."
                      rows="8"
                      [autoGrow]="true"
                      class="content-textarea scrollable-textarea">
                    </ion-textarea>
                  </ion-item>
                </div>
              </div>
                
              </div>
            </ion-content>
            <ion-footer class="entry-modal-footer">
              <div class="modal-actions">
                <ion-button (click)="deleteEntry()" fill="outline" class="cw-btn-danger" size="default">
                  <ion-icon name="trash" slot="start"></ion-icon>
                  Delete
                </ion-button>
                <ion-button (click)="saveEntry()" class="cw-btn-primary" size="default">
                  <ion-icon name="save" slot="start"></ion-icon>
                  Save
                </ion-button>
              </div>
            </ion-footer>
          </div>
        </ng-template>
      </ion-modal>

      <!-- Add Category Modal -->
      <ion-modal [isOpen]="showAddCategoryModal()" (didDismiss)="showAddCategoryModal.set(false)" class="category-modal">
        <ng-template>
          <ion-header>
            <ion-toolbar>
              <ion-title>New Category</ion-title>
              <ion-buttons slot="end">
                <ion-button (click)="addCategory()" class="cw-btn-primary">
                  <ion-icon name="save" slot="start"></ion-icon>
                  Create
                </ion-button>
                <ion-button (click)="showAddCategoryModal.set(false)" class="cw-btn-icon">
                  <ion-icon name="close" slot="icon-only"></ion-icon>
                </ion-button>
              </ion-buttons>
            </ion-toolbar>
          </ion-header>
          
          <ion-content>
            <ion-card>
              <ion-card-content>
                <ion-item>
                  <ion-label position="stacked">Category Name</ion-label>
                  <ion-input 
                    [(ngModel)]="newCategory.title" 
                    placeholder="Category Name"
                    type="text">
                  </ion-input>
                </ion-item>
                
                <ion-item>
                  <ion-label position="stacked">Icon (Emoji)</ion-label>
                  <ion-input 
                    [(ngModel)]="newCategory.icon" 
                    placeholder="ðŸ·ï¸"
                    maxlength="2"
                    type="text">
                  </ion-input>
                </ion-item>
                
                <ion-item>
                  <ion-label position="stacked">Description (optional)</ion-label>
                  <ion-textarea 
                    [(ngModel)]="newCategory.description" 
                    placeholder="Description..."
                    rows="3"
                    [autoGrow]="true"
                    class="scrollable-textarea">
                  </ion-textarea>
                </ion-item>
              </ion-card-content>
            </ion-card>
          </ion-content>
        </ng-template>
      </ion-modal>

    </div>
