<app-header
  title="Sync History"
  [leftActions]="leftActions">
</app-header>

<ion-content>
  <div class="sync-history-container">
    <!-- View Mode Selector -->
    <div class="controls-section">
      <ion-segment [value]="viewMode" (ionChange)="onViewModeChange($event)">
        <ion-segment-button value="logs">
          <ion-label>Sync Logs</ion-label>
        </ion-segment-button>
        <ion-segment-button value="stories">
          <ion-label>Story History</ion-label>
        </ion-segment-button>
      </ion-segment>
    </div>

    <!-- Filters and Actions (Logs View) -->
    <div class="filters-section" *ngIf="viewMode === 'logs'">
      <ion-searchbar
        [(ngModel)]="searchText"
        (ionInput)="onSearchChange($event)"
        placeholder="Search logs..."
        debounce="300">
      </ion-searchbar>

      <div class="filter-row">
        <ion-select
          [(ngModel)]="filterType"
          (ionChange)="onFilterChange($event)"
          interface="popover"
          placeholder="Filter by type">
          <ion-select-option value="all">All Types</ion-select-option>
          <ion-select-option value="upload">Uploads</ion-select-option>
          <ion-select-option value="download">Downloads</ion-select-option>
          <ion-select-option value="conflict">Conflicts</ion-select-option>
          <ion-select-option value="error">Errors</ion-select-option>
          <ion-select-option value="info">Info</ion-select-option>
        </ion-select>

        <ion-button fill="clear" (click)="refreshData()">
          <ion-icon slot="icon-only" name="refresh"></ion-icon>
        </ion-button>

        <ion-button fill="clear" (click)="clearLogs()">
          <ion-icon slot="icon-only" name="trash"></ion-icon>
        </ion-button>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-container" *ngIf="loading">
      <ion-spinner></ion-spinner>
      <p>Loading sync history...</p>
    </div>

    <!-- Logs View -->
    <div class="logs-view" *ngIf="viewMode === 'logs' && !loading">
      <div class="empty-state" *ngIf="filteredLogs.length === 0">
        <ion-icon name="information-circle" size="large"></ion-icon>
        <p *ngIf="allLogs.length === 0">No sync logs yet</p>
        <p *ngIf="allLogs.length > 0">No logs match your filters</p>
      </div>

      <ion-list *ngIf="filteredLogs.length > 0">
        <ion-item *ngFor="let log of filteredLogs; trackBy: trackByLogId">
          <ion-icon
            [name]="getTypeIcon(log.type)"
            [color]="getTypeColor(log.type)"
            slot="start">
          </ion-icon>

          <ion-label>
            <h2>{{ log.action }}</h2>
            <p *ngIf="log.details">{{ log.details }}</p>
            <div class="log-meta">
              <ion-chip *ngIf="log.deviceName" [color]="isCurrentDevice(log.deviceId) ? 'primary' : 'medium'">
                <ion-icon [name]="isCurrentDevice(log.deviceId) ? 'laptop' : 'desktop'"></ion-icon>
                <ion-label>{{ log.deviceName }}</ion-label>
                <ion-badge *ngIf="isCurrentDevice(log.deviceId)">Current</ion-badge>
              </ion-chip>
              <ion-chip *ngIf="log.itemCount">
                <ion-label>{{ log.itemCount }} items</ion-label>
              </ion-chip>
              <ion-chip *ngIf="log.duration">
                <ion-label>{{ log.duration }}ms</ion-label>
              </ion-chip>
              <ion-note>{{ formatDate(log.timestamp) }}</ion-note>
            </div>
          </ion-label>

          <ion-badge [color]="getStatusColor(log.status)" slot="end">
            {{ log.status }}
          </ion-badge>
        </ion-item>
      </ion-list>
    </div>

    <!-- Stories View -->
    <div class="stories-view" *ngIf="viewMode === 'stories' && !loading">
      <div class="empty-state" *ngIf="storyModifications.length === 0">
        <ion-icon name="information-circle" size="large"></ion-icon>
        <p>No story modifications tracked yet</p>
      </div>

      <ion-list *ngIf="storyModifications.length > 0">
        <ion-card *ngFor="let mod of storyModifications; trackBy: trackByStoryId" class="story-card">
          <ion-card-header>
            <ion-card-title>{{ mod.storyTitle }}</ion-card-title>
          </ion-card-header>

          <ion-card-content>
            <div class="modification-info" *ngIf="mod.lastModifiedBy">
              <h3>Last Modified By</h3>
              <div class="device-info">
                <ion-chip [color]="isCurrentDevice(mod.lastModifiedBy.deviceId) ? 'primary' : 'medium'">
                  <ion-icon [name]="isCurrentDevice(mod.lastModifiedBy.deviceId) ? 'laptop' : 'desktop'"></ion-icon>
                  <ion-label>{{ mod.lastModifiedBy.deviceName }}</ion-label>
                  <ion-badge *ngIf="isCurrentDevice(mod.lastModifiedBy.deviceId)">Current</ion-badge>
                </ion-chip>
                <ion-note>{{ formatDateTime(mod.lastModifiedBy.timestamp) }}</ion-note>
              </div>
            </div>

            <div class="sync-logs" *ngIf="mod.modifications.length > 0">
              <h3>Recent Sync Activity ({{ mod.modifications.length }})</h3>
              <ion-list lines="none">
                <ion-item *ngFor="let log of mod.modifications.slice(0, 5); trackBy: trackByLogId" class="mini-log">
                  <ion-icon
                    [name]="getTypeIcon(log.type)"
                    [color]="getTypeColor(log.type)"
                    slot="start"
                    size="small">
                  </ion-icon>
                  <ion-label>
                    <p>{{ log.action }}</p>
                    <ion-note>{{ formatDate(log.timestamp) }}</ion-note>
                  </ion-label>
                </ion-item>
              </ion-list>
            </div>

            <div *ngIf="!mod.lastModifiedBy && mod.modifications.length === 0" class="no-info">
              <ion-note>No modification history available</ion-note>
            </div>
          </ion-card-content>
        </ion-card>
      </ion-list>
    </div>
  </div>
</ion-content>
