<div class="ion-page">
  <app-header
    title="Story Settings"
    [showBackButton]="true"
    [backAction]="goBack.bind(this)"
    [rightActions]="headerActions">
  </app-header>

  <ion-content *ngIf="story">
    <!-- Tab Navigation -->
    <app-settings-tabs 
      [tabs]="tabItems" 
      [(selectedTab)]="selectedTab">
    </app-settings-tabs>

    <app-settings-content>
      <!-- Tab Content -->
      <div [ngSwitch]="selectedTab">
        
        <!-- General Tab -->
        <div *ngSwitchCase="'general'">
        <ion-card class="story-info-card">
          <ion-card-header>
            <ion-card-title>{{ story.title || 'Untitled Story' }}</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-note>
              Created: {{ story.createdAt | date:'short' }} | Last edited: {{ story.updatedAt | date:'short' }}
            </ion-note>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- Cover Image Tab -->
      <div *ngSwitchCase="'cover-image'">
        <ion-card class="settings-section">
          <ion-card-header>
            <ion-card-title>Cover Image</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-text color="medium">
              <p>Set a cover image for your story. The image will be displayed in the story list and editor header.</p>
            </ion-text>
            
            <app-image-upload
              [currentImage]="getCoverImageDataUrl()"
              [fileName]="getCoverImageFileName()"
              [fileSize]="getCoverImageFileSize()"
              (imageSelected)="onCoverImageSelected($event)"
              (imageRemoved)="onCoverImageRemoved()">
            </app-image-upload>
          </ion-card-content>
        </ion-card>
      </div>
      
      <!-- AI System Tab -->
      <div *ngSwitchCase="'ai-system'" class="ai-system-tab">
        <div class="ai-system-header">
          <h2>AI System Configuration</h2>
          <p>Configure the context and behavior of your AI assistant for this story</p>
        </div>

        <!-- Template Type Switcher - Global control above accordions -->
        <div class="template-type-section">
          <h3 class="template-type-label">Generation Template Type</h3>
          <div class="beat-type-toggle">
            <ion-segment [value]="activeBeatType" (ionChange)="onBeatTypeChange($any($event).detail.value)" aria-label="Select generation template type">
              <ion-segment-button value="story">
                <ion-label>Story Beat</ion-label>
              </ion-segment-button>
              <ion-segment-button value="scene">
                <ion-label>Scene Beat</ion-label>
              </ion-segment-button>
              <ion-segment-button value="sceneFromOutline">
                <ion-label>Scene from Outline</ion-label>
              </ion-segment-button>
            </ion-segment>
          </div>
        </div>

        <div class="beat-type-header">
          <ion-note class="beat-type-description">
            <span *ngIf="activeBeatType === 'story'">
              Story beats advance the narrative and move the plot forward.
            </span>
            <span *ngIf="activeBeatType === 'scene'">
              Scene beats expand moments with detail, focusing on immersion rather than plot.
            </span>
            <span *ngIf="activeBeatType === 'sceneFromOutline'">
              Generate a complete scene from an outline description (up to 5000 words).
            </span>
          </ion-note>
        </div>

        <ion-accordion-group [multiple]="true" [value]="['system-message']" class="ai-system-accordion" aria-label="AI System Settings">

          <!-- Language & System Message Accordion -->
          <ion-accordion value="system-message">
            <ion-item slot="header" lines="full">
              <ion-icon name="chatbox-outline" slot="start"></ion-icon>
              <ion-label>
                <h3>Language & System Message</h3>
                <p>AI personality and communication style</p>
              </ion-label>
              <ion-badge slot="end" color="primary">
                {{ (settings.language || 'en').toUpperCase() }}
              </ion-badge>
            </ion-item>
            <div slot="content" class="accordion-content">
              <div class="language-row">
                <ion-item class="language-select">
                  <ion-label position="stacked">Story Language</ion-label>
                  <ion-select
                    [(ngModel)]="settings.language"
                    (ionChange)="onSettingsChange()"
                    interface="popover"
                    aria-label="Select story language">
                    <ion-select-option value="en">English</ion-select-option>
                    <ion-select-option value="de">Deutsch</ion-select-option>
                    <ion-select-option value="fr">Français</ion-select-option>
                    <ion-select-option value="es">Español</ion-select-option>
                    <ion-select-option value="custom">Custom (use scene language)</ion-select-option>
                  </ion-select>
                </ion-item>
                <ion-button
                  fill="outline"
                  size="small"
                  (click)="refreshTemplates()"
                  color="primary"
                  class="reload-button">
                  <ion-icon name="refresh-outline" slot="start"></ion-icon>
                  Reload Templates
                </ion-button>
              </div>
              <ion-note class="language-note">
                <small>Changing the language affects AI outputs. Use "Reload Templates" to load language-specific templates.</small>
              </ion-note>

              <ion-label class="textarea-label">System Message</ion-label>
              <ion-textarea
                [(ngModel)]="settings.systemMessage"
                (ionInput)="onSettingsChange()"
                placeholder="Enter the system message that defines AI context and personality..."
                rows="18"
                class="settings-textarea"
                aria-label="System Message">
              </ion-textarea>
              <ion-note class="section-placement-note">
                This message is sent to the AI at the very start, before all other content.
              </ion-note>
              <ion-note class="char-count">{{ (settings.systemMessage || '').length }} characters</ion-note>
            </div>
          </ion-accordion>

          <!-- Generation Templates Accordion -->
          <ion-accordion value="beat-template">
            <ion-item slot="header" lines="full">
              <ion-icon name="code-slash-outline" slot="start"></ion-icon>
              <ion-label>
                <h3>Generation Template — {{ getTemplateTypeName() }}</h3>
                <p>Configure prompts for {{ getTemplateTypeName().toLowerCase() }} generation</p>
              </ion-label>
            </ion-item>
            <div slot="content" class="accordion-content">
              <!-- Section Editor Component -->
              <app-beat-template-sections
                [beatType]="activeBeatType"
                [sections]="beatTemplateSections"
                [sceneSections]="sceneBeatTemplateSections"
                [sceneFromOutlineSections]="sceneFromOutlineTemplateSections"
                (sectionsChange)="onBeatSectionsChange($event)"
                (sceneSectionsChange)="onSceneBeatSectionsChange($event)"
                (sceneFromOutlineSectionsChange)="onSceneFromOutlineSectionsChange($event)">
              </app-beat-template-sections>
            </div>
          </ion-accordion>

          <!-- Generation Rules Accordion -->
          <ion-accordion value="beat-rules">
            <ion-item slot="header" lines="full">
              <ion-icon name="list-outline" slot="start"></ion-icon>
              <ion-label>
                <h3>Generation Rules</h3>
                <p>Custom rules for AI output</p>
              </ion-label>
              <ion-badge slot="end" [color]="(settings.beatRules || '').length > 0 ? 'primary' : 'medium'">
                {{ (settings.beatRules || '').length || 'None' }}
              </ion-badge>
            </ion-item>
            <div slot="content" class="accordion-content">
              <ion-text color="medium">
                <p>Define custom rules that will be included in every beat generation prompt.</p>
              </ion-text>

              <ion-label class="textarea-label">Generation Rules</ion-label>
              <ion-textarea
                [(ngModel)]="settings.beatRules"
                (ionInput)="onSettingsChange()"
                placeholder="Enter your custom rules here...&#10;&#10;Example:&#10;- Always use vivid sensory descriptions&#10;- Keep dialogue concise and punchy&#10;- Avoid purple prose"
                rows="24"
                class="settings-textarea"
                aria-label="Generation Rules">
              </ion-textarea>
              <ion-note class="section-placement-note">
                These rules are inserted after Constraints, before Output Format in the prompt.
              </ion-note>
              <ion-note class="char-count">{{ (settings.beatRules || '').length }} characters</ion-note>
            </div>
          </ion-accordion>

        </ion-accordion-group>
      </div>

      <!-- Beat Config Tab -->
      <div *ngSwitchCase="'beat-config'">
        <ion-card class="settings-section">
          <ion-card-header>
            <ion-card-title>Beat AI Configuration</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-text color="medium">
              <p>Configuration for Beat AI generation.</p>
            </ion-text>
            
            <ion-item class="setting-item">
              <ion-checkbox
                [(ngModel)]="settings.useFullStoryContext"
                (ionChange)="onSettingsChange()"
                slot="start">
              </ion-checkbox>
              <ion-label>
                <h3>Use Complete Story Context</h3>
                <p>When enabled, the complete text of all scenes is used as context. Otherwise, only summaries are used (if available).</p>
              </ion-label>
            </ion-item>

            <ion-item class="setting-item">
              <ion-label position="stacked">
                <h3>Narrative Perspective (POV)</h3>
                <p>Point of view for AI-generated content. POV character is auto-detected from Codex (character with Protagonist role).</p>
              </ion-label>
              <ion-select
                [(ngModel)]="settings.narrativePerspective"
                (ionChange)="onSettingsChange()"
                interface="popover"
                aria-label="Select narrative perspective">
                <ion-select-option *ngFor="let option of narrativePerspectiveOptions" [value]="option.value">
                  {{ option.label }}
                </ion-select-option>
              </ion-select>
            </ion-item>

            <ion-item class="setting-item">
              <ion-label position="stacked">
                <h3>Tense</h3>
                <p>The grammatical tense for AI-generated content.</p>
              </ion-label>
              <ion-select
                [(ngModel)]="settings.tense"
                (ionChange)="onSettingsChange()"
                interface="popover"
                aria-label="Select tense">
                <ion-select-option *ngFor="let option of tenseOptions" [value]="option.value">
                  {{ option.label }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </ion-card-content>
        </ion-card>
      </div>

      <!-- AI Favorites Tab -->
      <div *ngSwitchCase="'favorites'" class="favorites-tab">
        <div class="favorites-header">
          <h2>AI Model Favorites</h2>
          <p>Configure quick-access models for different AI features. Select up to 6 models for each feature.</p>
        </div>

        <ion-accordion-group [multiple]="false" value="beatInput" class="favorites-accordion">
          <!-- Beat Input -->
          <ion-accordion value="beatInput">
            <ion-item slot="header" lines="full">
              <ion-icon name="create-outline" slot="start"></ion-icon>
              <ion-label>
                <h3>Beat Input</h3>
                <p>Quick-select models in the Beat AI panel</p>
              </ion-label>
              <ion-badge slot="end" color="primary">
                {{ settings.favoriteModelLists?.beatInput?.length || 0 }}
              </ion-badge>
            </ion-item>
            <div slot="content" class="accordion-content">
              <app-model-favorites-settings
                [favoriteIds]="settings.favoriteModelLists?.beatInput || []"
                [combinedModels]="combinedModels"
                [loadingModels]="loadingModels"
                [modelLoadError]="modelLoadError"
                [showCard]="false"
                (favoriteIdsChange)="onFavoriteModelsChange('beatInput', $event)">
              </app-model-favorites-settings>
            </div>
          </ion-accordion>

          <!-- Scene Summary -->
          <ion-accordion value="sceneSummary">
            <ion-item slot="header" lines="full">
              <ion-icon name="document-text-outline" slot="start"></ion-icon>
              <ion-label>
                <h3>Scene Summary</h3>
                <p>Quick-select for scene summaries</p>
              </ion-label>
              <ion-badge slot="end" color="primary">
                {{ settings.favoriteModelLists?.sceneSummary?.length || 0 }}
              </ion-badge>
            </ion-item>
            <div slot="content" class="accordion-content">
              <app-model-favorites-settings
                [favoriteIds]="settings.favoriteModelLists?.sceneSummary || []"
                [combinedModels]="combinedModels"
                [loadingModels]="loadingModels"
                [modelLoadError]="modelLoadError"
                [showCard]="false"
                (favoriteIdsChange)="onFavoriteModelsChange('sceneSummary', $event)">
              </app-model-favorites-settings>
            </div>
          </ion-accordion>

          <!-- Rewrite -->
          <ion-accordion value="rewrite">
            <ion-item slot="header" lines="full">
              <ion-icon name="sync-outline" slot="start"></ion-icon>
              <ion-label>
                <h3>Rewrite</h3>
                <p>Quick-select for AI rewrite</p>
              </ion-label>
              <ion-badge slot="end" color="primary">
                {{ settings.favoriteModelLists?.rewrite?.length || 0 }}
              </ion-badge>
            </ion-item>
            <div slot="content" class="accordion-content">
              <app-model-favorites-settings
                [favoriteIds]="settings.favoriteModelLists?.rewrite || []"
                [combinedModels]="combinedModels"
                [loadingModels]="loadingModels"
                [modelLoadError]="modelLoadError"
                [showCard]="false"
                (favoriteIdsChange)="onFavoriteModelsChange('rewrite', $event)">
              </app-model-favorites-settings>
            </div>
          </ion-accordion>

          <!-- Character Chat -->
          <ion-accordion value="characterChat">
            <ion-item slot="header" lines="full">
              <ion-icon name="chatbubbles-outline" slot="start"></ion-icon>
              <ion-label>
                <h3>Character Chat</h3>
                <p>Quick-select for character conversations</p>
              </ion-label>
              <ion-badge slot="end" color="primary">
                {{ settings.favoriteModelLists?.characterChat?.length || 0 }}
              </ion-badge>
            </ion-item>
            <div slot="content" class="accordion-content">
              <app-model-favorites-settings
                [favoriteIds]="settings.favoriteModelLists?.characterChat || []"
                [combinedModels]="combinedModels"
                [loadingModels]="loadingModels"
                [modelLoadError]="modelLoadError"
                [showCard]="false"
                (favoriteIdsChange)="onFavoriteModelsChange('characterChat', $event)">
              </app-model-favorites-settings>
            </div>
          </ion-accordion>
        </ion-accordion-group>
      </div>

      <!-- Export/Import Tab -->
      <div *ngSwitchCase="'export-import'">
        <!-- Export Section -->
        <ion-card class="settings-section">
          <ion-card-header>
            <ion-card-title>Export Story</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-text color="medium">
              <p>Export this story and its Codex as a JSON file. The export can be imported into another Creative Writer database.</p>
            </ion-text>

            <div class="export-info">
              <ion-grid>
                <ion-row>
                  <ion-col size="6" size-md="3">
                    <div class="stat-item">
                      <ion-text color="primary">
                        <h3>{{ story.chapters?.length || 0 }}</h3>
                      </ion-text>
                      <ion-note>Chapters</ion-note>
                    </div>
                  </ion-col>
                  <ion-col size="6" size-md="3">
                    <div class="stat-item">
                      <ion-text color="primary">
                        <h3>{{ getStorySceneCount() }}</h3>
                      </ion-text>
                      <ion-note>Scenes</ion-note>
                    </div>
                  </ion-col>
                </ion-row>
              </ion-grid>
            </div>

            <ion-button
              (click)="exportStory()"
              [disabled]="isExporting"
              color="primary">
              <ion-icon name="download-outline" slot="start"></ion-icon>
              {{ isExporting ? 'Exporting...' : 'Export Story' }}
            </ion-button>
          </ion-card-content>
        </ion-card>

        <!-- Import Section -->
        <ion-card class="settings-section">
          <ion-card-header>
            <ion-card-title>Import Story</ion-card-title>
          </ion-card-header>
          <ion-card-content>
            <ion-text color="medium">
              <p>Import a story from a JSON export file. A new story will be created with all imported data.</p>
            </ion-text>

            <!-- File Input -->
            <div class="file-input-wrapper" *ngIf="!importPreview">
              <input
                type="file"
                accept=".json"
                (change)="onImportFileSelected($event)"
                id="importFileInput"
                class="hidden-file-input">
              <label for="importFileInput" class="file-input-label">
                <ion-icon name="cloud-upload-outline"></ion-icon>
                <span>Choose JSON file or drag here</span>
              </label>
            </div>

            <!-- Error Message -->
            <div *ngIf="importError" class="import-error">
              <ion-icon name="alert-circle-outline" color="danger"></ion-icon>
              <ion-text color="danger">{{ importError }}</ion-text>
            </div>

            <!-- Import Preview -->
            <div *ngIf="importPreview" class="import-preview">
              <ion-card class="preview-card">
                <ion-card-header>
                  <ion-card-title>
                    <ion-icon name="document-outline"></ion-icon>
                    {{ importPreview.story.title }}
                  </ion-card-title>
                </ion-card-header>
                <ion-card-content>
                  <ion-grid>
                    <ion-row>
                      <ion-col size="4">
                        <div class="preview-stat">
                          <strong>{{ getImportChapterCount() }}</strong>
                          <span>Chapters</span>
                        </div>
                      </ion-col>
                      <ion-col size="4">
                        <div class="preview-stat">
                          <strong>{{ getImportSceneCount() }}</strong>
                          <span>Scenes</span>
                        </div>
                      </ion-col>
                      <ion-col size="4">
                        <div class="preview-stat">
                          <strong>{{ getImportCodexEntryCount() }}</strong>
                          <span>Codex Entries</span>
                        </div>
                      </ion-col>
                    </ion-row>
                  </ion-grid>

                  <ion-note *ngIf="importPreview.codex">
                    <ion-icon name="checkmark-circle-outline" color="success"></ion-icon>
                    Includes Codex data
                  </ion-note>

                  <ion-note *ngIf="!importPreview.codex">
                    <ion-icon name="information-circle-outline" color="medium"></ion-icon>
                    No Codex data included
                  </ion-note>

                  <div class="preview-actions">
                    <ion-button
                      (click)="confirmImport()"
                      [disabled]="isImporting"
                      color="primary">
                      <ion-icon name="cloud-download-outline" slot="start"></ion-icon>
                      {{ isImporting ? 'Importing...' : 'Import Story' }}
                    </ion-button>
                    <ion-button
                      (click)="cancelImport()"
                      fill="outline"
                      color="medium"
                      [disabled]="isImporting">
                      Cancel
                    </ion-button>
                  </div>
                </ion-card-content>
              </ion-card>
            </div>
          </ion-card-content>
        </ion-card>
      </div>

    </div>
    </app-settings-content>

    <div class="settings-actions">
    <ion-button 
      expand="block" 
      color="primary" 
      (click)="saveSettings()" 
      [disabled]="!hasUnsavedChanges"
      class="save-button">
      <ion-icon name="save-outline" slot="start"></ion-icon>
      Save Settings
    </ion-button>
    
    <ion-button
      expand="block"
      fill="outline"
      color="medium"
      (click)="resetToDefaults()"
      class="reset-button">
      <ion-icon name="refresh-outline" slot="start"></ion-icon>
      Reset to Default
    </ion-button>
    </div>

    <!-- Template Preview Modal -->
    <app-beat-ai-preview-modal
      [isVisible]="showTemplatePreview"
      [content]="templatePreviewContent"
      (closeModal)="showTemplatePreview = false">
    </app-beat-ai-preview-modal>

    <!-- Preview Template FAB - only visible on AI System tab -->
    <ion-fab *ngIf="selectedTab === 'ai-system'" slot="fixed" vertical="bottom" horizontal="end">
      <ion-fab-button (click)="openTemplatePreview()" color="primary">
        <ion-icon name="eye-outline"></ion-icon>
      </ion-fab-button>
    </ion-fab>
  </ion-content>

  <ion-content *ngIf="!story">
    <div class="no-story">
      <ion-text color="medium">
        <p>Story not found.</p>
      </ion-text>
    </div>
  </ion-content>
</div>
