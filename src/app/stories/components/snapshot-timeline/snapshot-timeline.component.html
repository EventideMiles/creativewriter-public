<ion-header>
  <ion-toolbar>
    <ion-title>Version History - {{ storyTitle }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="close()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <!-- Loading State -->
  <div *ngIf="loading" class="loading-container">
    <ion-spinner></ion-spinner>
    <p>Loading version history...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="!loading && error" class="error-container">
    <ion-icon name="cloud-offline-outline" size="large"></ion-icon>
    <h3>{{ error }}</h3>
    <ion-button (click)="loadTimeline()">Retry</ion-button>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && !error && getTotalSnapshotCount() === 0" class="empty-container">
    <ion-icon name="time-outline" size="large"></ion-icon>
    <h3>No Snapshots Yet</h3>
    <p>Automatic snapshots will be created as you edit your story.</p>
    <ion-button (click)="createManualSnapshot()">Create Manual Snapshot</ion-button>
  </div>

  <!-- Timeline Content -->
  <div *ngIf="!loading && !error && timeline && getTotalSnapshotCount() > 0">
    <!-- Header with Manual Snapshot Button -->
    <div class="timeline-header">
      <p class="snapshot-count">{{ getTotalSnapshotCount() }} snapshots available</p>
      <ion-button size="small" (click)="createManualSnapshot()">
        <ion-icon name="bookmark-outline" slot="start"></ion-icon>
        Create Snapshot
      </ion-button>
    </div>

    <!-- Recent (15-min granular) -->
    <ion-list *ngIf="timeline.recent.length > 0">
      <ion-list-header>
        <ion-label>
          <h2>Recent (Last 4 hours)</h2>
          <p>{{ timeline.recent.length }} snapshots every 15 minutes</p>
        </ion-label>
      </ion-list-header>
      <ion-item *ngFor="let snapshot of timeline.recent">
        <ion-label>
          <h3>{{ snapshotService.formatSnapshotTime(snapshot.createdAt) }}</h3>
          <p>{{ snapshot.metadata.wordCount | number }} words, {{ snapshot.metadata.chapterCount }} chapters</p>
        </ion-label>
        <ion-button slot="end" fill="outline" size="small" (click)="restore(snapshot)">
          Restore
        </ion-button>
      </ion-item>
    </ion-list>

    <!-- Hourly -->
    <ion-list *ngIf="timeline.hourly.length > 0">
      <ion-list-header>
        <ion-label>
          <h2>Hourly (Last 24 hours)</h2>
          <p>{{ timeline.hourly.length }} snapshots</p>
        </ion-label>
      </ion-list-header>
      <ion-item *ngFor="let snapshot of timeline.hourly">
        <ion-label>
          <h3>{{ snapshotService.formatSnapshotTime(snapshot.createdAt) }}</h3>
          <p>{{ snapshot.metadata.wordCount | number }} words, {{ snapshot.metadata.chapterCount }} chapters</p>
        </ion-label>
        <ion-button slot="end" fill="outline" size="small" (click)="restore(snapshot)">
          Restore
        </ion-button>
      </ion-item>
    </ion-list>

    <!-- Daily -->
    <ion-list *ngIf="timeline.daily.length > 0">
      <ion-list-header>
        <ion-label>
          <h2>Daily (Last 30 days)</h2>
          <p>{{ timeline.daily.length }} snapshots</p>
        </ion-label>
      </ion-list-header>
      <ion-item *ngFor="let snapshot of timeline.daily">
        <ion-label>
          <h3>{{ snapshotService.formatSnapshotTime(snapshot.createdAt) }}</h3>
          <p>{{ snapshot.metadata.wordCount | number }} words, {{ snapshot.metadata.chapterCount }} chapters</p>
        </ion-label>
        <ion-button slot="end" fill="outline" size="small" (click)="restore(snapshot)">
          Restore
        </ion-button>
      </ion-item>
    </ion-list>

    <!-- Weekly -->
    <ion-list *ngIf="timeline.weekly.length > 0">
      <ion-list-header>
        <ion-label>
          <h2>Weekly (Last 12 weeks)</h2>
          <p>{{ timeline.weekly.length }} snapshots</p>
        </ion-label>
      </ion-list-header>
      <ion-item *ngFor="let snapshot of timeline.weekly">
        <ion-label>
          <h3>{{ snapshotService.formatSnapshotTime(snapshot.createdAt) }}</h3>
          <p>{{ snapshot.metadata.wordCount | number }} words, {{ snapshot.metadata.chapterCount }} chapters</p>
        </ion-label>
        <ion-button slot="end" fill="outline" size="small" (click)="restore(snapshot)">
          Restore
        </ion-button>
      </ion-item>
    </ion-list>

    <!-- Monthly -->
    <ion-list *ngIf="timeline.monthly.length > 0">
      <ion-list-header>
        <ion-label>
          <h2>Monthly (Last 12 months)</h2>
          <p>{{ timeline.monthly.length }} snapshots</p>
        </ion-label>
      </ion-list-header>
      <ion-item *ngFor="let snapshot of timeline.monthly">
        <ion-label>
          <h3>{{ snapshotService.formatSnapshotTime(snapshot.createdAt) }}</h3>
          <p>{{ snapshot.metadata.wordCount | number }} words, {{ snapshot.metadata.chapterCount }} chapters</p>
        </ion-label>
        <ion-button slot="end" fill="outline" size="small" (click)="restore(snapshot)">
          Restore
        </ion-button>
      </ion-item>
    </ion-list>

    <!-- Manual Snapshots -->
    <ion-list *ngIf="timeline.manual.length > 0">
      <ion-list-header>
        <ion-label>
          <h2>Manual Snapshots</h2>
          <p>{{ timeline.manual.length }} snapshots</p>
        </ion-label>
      </ion-list-header>
      <ion-item *ngFor="let snapshot of timeline.manual">
        <ion-icon name="bookmark" slot="start" color="primary"></ion-icon>
        <ion-label>
          <h3>{{ snapshot.reason || 'Manual snapshot' }}</h3>
          <p>{{ snapshotService.formatSnapshotTime(snapshot.createdAt) }}</p>
          <p>{{ snapshot.metadata.wordCount | number }} words, {{ snapshot.metadata.chapterCount }} chapters</p>
        </ion-label>
        <ion-button slot="end" fill="outline" size="small" (click)="restore(snapshot)">
          Restore
        </ion-button>
      </ion-item>
    </ion-list>
  </div>
</ion-content>
