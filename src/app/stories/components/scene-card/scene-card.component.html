<ion-card class="scene-card" [id]="'scene-' + scene.id">
  <ion-card-header>
    <div class="scene-header">
      <ion-card-title>
        @if (!editingTitle()) {
          <span class="idx">{{ scene.sceneNumber }}.</span>
          <span class="title-text">{{ scene.title || 'Untitled Scene' }}</span>
          <div class="inline-actions">
            <button
              class="cw-btn-glass-primary cw-btn-glass--sm"
              (click)="startEditTitle(); $event.stopPropagation()"
              title="Edit title"
              aria-label="Edit title">
              <ion-icon name="create-outline" aria-hidden="true"></ion-icon>
            </button>
            <button
              class="cw-btn-glass-success cw-btn-glass--sm"
              (click)="generateTitle()"
              [disabled]="generatingTitle || !canGenerateAI"
              title="Generate AI title"
              aria-label="Generate AI title">
              <ion-icon [name]="generatingTitle ? 'sync-outline' : 'sparkles-outline'"
                        [class.spinning]="generatingTitle"
                        aria-hidden="true"></ion-icon>
            </button>
          </div>
          @if (!scene.summary) {
            <ion-badge color="warning">No summary</ion-badge>
          }
        } @else {
          <div class="title-edit">
            <span class="idx">{{ scene.sceneNumber }}.</span>
            <ion-input
              class="title-input"
              [ngModel]="editTitleValue()"
              (ngModelChange)="editTitleValue.set($event)"
              placeholder="Untitled Scene"
              (keydown)="onTitleKeydown($event)">
            </ion-input>
          </div>
        }
      </ion-card-title>
      <ion-note class="scene-word-count" color="medium">
        {{ wordCountLabel }}
      </ion-note>
    </div>
  </ion-card-header>

  <ion-card-content>
    @if (!editingSummary()) {
      <div class="summary-container">
        <div class="summary-header">
          @if (scene.summary && scene.summaryGeneratedAt) {
            <div class="ai-indicator" title="AI-generated summary" role="status" aria-label="AI-generated summary">
              <ion-icon name="sparkles-outline" aria-hidden="true"></ion-icon>
            </div>
          }
          <div class="inline-actions summary-actions">
            <button
              class="cw-btn-glass-primary cw-btn-glass--sm"
              (click)="startEditSummary(); $event.stopPropagation()"
              title="Edit summary"
              aria-label="Edit summary">
              <ion-icon name="create-outline" aria-hidden="true"></ion-icon>
            </button>
            <button
              class="cw-btn-glass-success cw-btn-glass--sm"
              (click)="generateSummary()"
              [disabled]="generatingSummary || !canGenerateAI"
              title="Generate AI summary"
              aria-label="Generate AI summary">
              <ion-icon [name]="generatingSummary ? 'sync-outline' : 'sparkles-outline'"
                        [class.spinning]="generatingSummary"
                        aria-hidden="true"></ion-icon>
            </button>
          </div>
        </div>
        <div class="summary" [class.placeholder]="!scene.summary">
          {{ scene.summary || 'No summary available for this scene.' }}
        </div>
      </div>
    } @else {
      <div class="summary-edit">
        <ion-textarea
          [ngModel]="editSummaryValue()"
          (ngModelChange)="editSummaryValue.set($event)"
          [autoGrow]="false"
          [rows]="6"
          placeholder="Write a short summary for this scene..."
          (keydown)="onSummaryKeydown($event)">
        </ion-textarea>
        <div class="edit-hints">
          <span class="word-count">{{ editSummaryWordCount() }} words</span>
          <span class="keyboard-hint">Ctrl+Enter to save â€¢ Esc to cancel</span>
        </div>
      </div>
    }

    <div class="actions">
      <!-- Title editing state -->
      @if (editingTitle()) {
        <ion-button
          size="small"
          color="primary"
          (click)="saveTitle()"
          [disabled]="savingTitle"
          title="Save title (Enter)">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Save Title
        </ion-button>
        <ion-button
          size="small"
          fill="outline"
          color="medium"
          (click)="cancelEditTitle()"
          [disabled]="savingTitle"
          title="Cancel (Esc)">
          <ion-icon name="close-outline" slot="start"></ion-icon>
          Cancel
        </ion-button>
      }

      <!-- Summary editing state -->
      @if (editingSummary()) {
        <ion-button
          size="small"
          color="primary"
          (click)="saveSummary()"
          [disabled]="savingSummary"
          title="Save summary (Ctrl+Enter)">
          <ion-icon name="save-outline" slot="start"></ion-icon>
          Save
        </ion-button>
        <ion-button
          size="small"
          fill="outline"
          color="medium"
          (click)="cancelEditSummary()"
          [disabled]="savingSummary"
          title="Cancel (Esc)">
          <ion-icon name="close-outline" slot="start"></ion-icon>
          Cancel
        </ion-button>
      }
    </div>
  </ion-card-content>
</ion-card>
