<ion-accordion-group
  [multiple]="true"
  [value]="expandedAccordions"
  (ionChange)="onAccordionChange($event)">

  @for (meta of sectionMeta; track meta.key) {
    <!-- Context indicators after userMessagePreamble (before objective) -->
    @if (meta.key === 'objective') {
      <div class="context-indicator-group">
        <div class="context-indicator">
          <ion-icon name="bookmark-outline"></ion-icon>
          <span>Story title inserted here</span>
        </div>
        <div class="context-indicator">
          <ion-icon name="book-outline"></ion-icon>
          <span>Glossary/Codex entries inserted here</span>
        </div>
        <div class="context-indicator">
          <ion-icon name="documents-outline"></ion-icon>
          <span>Previous chapters & scenes inserted here</span>
        </div>
        <div class="context-indicator">
          <ion-icon name="document-text-outline"></ion-icon>
          <span>Current scene text inserted here</span>
        </div>
      </div>
    }

    <!-- Bridging context indicator (scene beats only, after beatRequirements) -->
    @if (beatType === 'scene' && meta.key === 'styleGuidance') {
      <div class="context-indicator-group">
        <div class="context-indicator">
          <ion-icon name="git-merge-outline"></ion-icon>
          <span>Bridging context inserted here (when text exists after beat)</span>
        </div>
      </div>
    }

    <!-- Rules indicator after constraints (before outputFormat) -->
    @if (meta.key === 'outputFormat') {
      <div class="context-indicator-group">
        <div class="context-indicator">
          <ion-icon name="list-outline"></ion-icon>
          <span>Generation Rules inserted here</span>
        </div>
      </div>
    }

    <ion-accordion [value]="meta.key">
      <ion-item slot="header" lines="full">
        <ion-label>
          <h3>{{ meta.label }}</h3>
          <p class="section-description">{{ meta.description }}</p>
        </ion-label>
        @if (meta.required) {
          <ion-badge color="warning" slot="end">Required</ion-badge>
        }
        @if (hasValidationError(meta)) {
          <ion-icon name="warning-outline" color="warning" slot="end" class="validation-icon"></ion-icon>
        } @else if (meta.placeholders.length > 0) {
          <ion-icon name="checkmark-circle-outline" color="success" slot="end" class="validation-icon"></ion-icon>
        }
      </ion-item>

      <div slot="content" class="section-content">
        <!-- Placeholder chips -->
        @if (meta.placeholders.length > 0) {
          <div class="placeholders-container">
            <ion-note class="placeholders-label">Available placeholders:</ion-note>
            <div class="placeholder-chips">
              @for (placeholder of meta.placeholders; track placeholder) {
                <ion-chip color="warning" class="placeholder-chip">
                  {{ placeholder }}
                </ion-chip>
              }
            </div>
          </div>
        }

        <!-- Textarea for section content -->
        <ion-textarea
          [value]="getSectionValue(meta.key)"
          (ionInput)="onSectionChange(meta.key, $any($event).target.value)"
          [rows]="meta.rows"
          class="section-textarea"
          [placeholder]="'Enter ' + meta.label.toLowerCase() + '...'"
          [attr.aria-label]="meta.label">
        </ion-textarea>

        <!-- Footer with char count, validation, and reset -->
        @let missingPlaceholders = getMissingPlaceholders(meta);
        <div class="section-footer">
          <ion-note class="char-count">
            {{ getCharacterCount(meta.key) }} characters
          </ion-note>

          @if (missingPlaceholders.length > 0) {
            <ion-note color="warning" class="validation-warning">
              <ion-icon name="warning-outline"></ion-icon>
              Missing: {{ missingPlaceholders.join(', ') }}
            </ion-note>
          }

          <ion-button
            fill="clear"
            size="small"
            color="medium"
            (click)="resetSection(meta.key)"
            class="reset-section-button"
            title="Reset to default">
            <ion-icon name="refresh-outline" slot="icon-only"></ion-icon>
          </ion-button>
        </div>
      </div>
    </ion-accordion>
  }

</ion-accordion-group>

<!-- Reset All Button -->
<div class="reset-all-container">
  <ion-button
    fill="outline"
    size="small"
    color="medium"
    (click)="resetAllSections()">
    <ion-icon name="refresh-outline" slot="start"></ion-icon>
    Reset All Sections
  </ion-button>
</div>
