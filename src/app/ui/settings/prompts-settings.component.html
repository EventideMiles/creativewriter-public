<!-- ============================================
     AI Prompts Settings - Accordion Layout
     Configure prompts for various AI features
     ============================================ -->

<ion-accordion-group [multiple]="true" [value]="['scene-title']" class="prompts-accordion">

  <!-- Scene Title Generation -->
  <ion-accordion value="scene-title">
    <ion-item slot="header" lines="full">
      <ion-icon name="bookmark-outline" slot="start"></ion-icon>
      <ion-label>
        <h3>Scene Title Generation</h3>
        <p>Configure AI-generated scene titles</p>
      </ion-label>
      <ion-badge slot="end" color="primary">
        {{ getModelDisplayName(settings.sceneTitleGeneration.selectedModel) }}
      </ion-badge>
    </ion-item>
    <div slot="content" class="accordion-content">
      <p class="section-description">
        Customize how the AI generates titles for your scenes based on their content.
      </p>

      <ion-item>
        <ion-label>Maximum Word Count</ion-label>
        <ion-range
          [(ngModel)]="settings.sceneTitleGeneration.maxWords"
          (ngModelChange)="settingsChange.emit()"
          min="1"
          max="20"
          step="1"
          snaps="true"
          ticks="true"
          slot="end">
          <ion-label slot="start">1</ion-label>
          <ion-label slot="end">20</ion-label>
        </ion-range>
      </ion-item>

      <ion-item>
        <ion-label>Style</ion-label>
        <ion-select
          [(ngModel)]="settings.sceneTitleGeneration.style"
          (ngModelChange)="settingsChange.emit()"
          interface="popover"
          slot="end">
          <ion-select-option value="concise">Concise</ion-select-option>
          <ion-select-option value="descriptive">Descriptive</ion-select-option>
          <ion-select-option value="action">Action-packed</ion-select-option>
          <ion-select-option value="emotional">Emotional</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label>Language</ion-label>
        <ion-select
          [(ngModel)]="settings.sceneTitleGeneration.language"
          (ngModelChange)="settingsChange.emit()"
          interface="popover"
          slot="end">
          <ion-select-option value="german">German</ion-select-option>
          <ion-select-option value="english">English</ion-select-option>
        </ion-select>
      </ion-item>

      <ion-item>
        <ion-label>Consider Genre</ion-label>
        <ion-toggle
          [(ngModel)]="settings.sceneTitleGeneration.includeGenre"
          (ngModelChange)="settingsChange.emit()"
          slot="end">
        </ion-toggle>
      </ion-item>

      <ion-item>
        <ion-label>Creativity (Temperature)</ion-label>
        <ion-range
          [(ngModel)]="settings.sceneTitleGeneration.temperature"
          (ngModelChange)="settingsChange.emit()"
          min="0.1"
          max="1.0"
          step="0.1"
          snaps="true"
          slot="end">
          <ion-label slot="start">0.1</ion-label>
          <ion-label slot="end">1.0</ion-label>
        </ion-range>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">AI Model for Scene Titles</ion-label>
        <div class="model-selection-container">
          <ng-select [(ngModel)]="settings.sceneTitleGeneration.selectedModel"
                     [items]="combinedModels"
                     bindLabel="label"
                     bindValue="id"
                     [searchable]="true"
                     [clearable]="true"
                     [disabled]="modelsDisabled"
                     placeholder="Select model (empty = use global model)"
                     (ngModelChange)="settingsChange.emit()"
                     [loading]="loadingModels"
                     [virtualScroll]="true"
                     class="ng-select-custom"
                     appendTo="body">
            <ng-template ng-option-tmp let-item="item">
              <div class="model-option">
                <div class="model-option-header">
                  <ion-icon
                    [name]="getProviderIcon(item.provider)"
                    class="provider-icon"
                    [class.gemini]="item.provider === 'gemini'"
                    [class.openrouter]="item.provider === 'openrouter'"
                    [class.ollama]="item.provider === 'ollama'"
                    [class.claude]="item.provider === 'claude'"
                    [class.replicate]="item.provider === 'replicate'"
                    [title]="getProviderTooltip(item.provider)"></ion-icon>
                  <span class="model-label">{{ item.label }}</span>
                </div>
                <div class="model-option-details">
                  <span class="model-cost">Input: {{ item.costInputEur }} | Output: {{ item.costOutputEur }}</span>
                  <span class="model-context">Context: {{ formatContextLength(item.contextLength) }}</span>
                </div>
                <div class="model-description" *ngIf="item.description">{{ item.description }}</div>
              </div>
            </ng-template>
          </ng-select>
          <div class="model-info-small">
            <p *ngIf="modelLoadError" class="error-text">{{ modelLoadError }}</p>
            <p *ngIf="!modelLoadError && !settings.sceneTitleGeneration.selectedModel" class="info-text">
              No model selected - the global model will be used
            </p>
            <p *ngIf="!modelLoadError && settings.sceneTitleGeneration.selectedModel" class="info-text">
              Specific model for scene titles: {{ getModelDisplayName(settings.sceneTitleGeneration.selectedModel) }}
            </p>
          </div>
        </div>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Additional Instructions (optional)</ion-label>
        <ion-textarea
          [(ngModel)]="settings.sceneTitleGeneration.customInstruction"
          (ngModelChange)="settingsChange.emit()"
          placeholder="e.g. 'Don't use articles' or 'Focus on emotions'"
          rows="3"
          auto-grow="true">
        </ion-textarea>
      </ion-item>

      <ion-item>
        <ion-label>Use Custom Prompt</ion-label>
        <ion-toggle
          [(ngModel)]="settings.sceneTitleGeneration.useCustomPrompt"
          (ngModelChange)="settingsChange.emit()"
          slot="end">
        </ion-toggle>
      </ion-item>

      <ion-item *ngIf="settings.sceneTitleGeneration.useCustomPrompt">
        <ion-label position="stacked">
          Custom Prompt
          <p class="prompt-help">
            Available placeholders: {{ '{' }}maxWords{{ '}' }}, {{ '{' }}styleInstruction{{ '}' }}, {{ '{' }}genreInstruction{{ '}' }}, {{ '{' }}languageInstruction{{ '}' }}, {{ '{' }}customInstruction{{ '}' }}, {{ '{' }}sceneContent{{ '}' }}
          </p>
        </ion-label>
        <ion-textarea
          [(ngModel)]="settings.sceneTitleGeneration.customPrompt"
          (ngModelChange)="settingsChange.emit()"
          placeholder="Create a short title for the following scene..."
          rows="8"
          auto-grow="true">
        </ion-textarea>
      </ion-item>

      <ion-item *ngIf="settings.sceneTitleGeneration.useCustomPrompt">
        <ion-button fill="outline" size="small" (click)="resetToDefaultPrompt()">
          Restore Default Prompt
        </ion-button>
      </ion-item>
    </div>
  </ion-accordion>

  <!-- Scene Summary Generation -->
  <ion-accordion value="scene-summary">
    <ion-item slot="header" lines="full">
      <ion-icon name="document-text-outline" slot="start"></ion-icon>
      <ion-label>
        <h3>Scene Summary</h3>
        <p>Configure AI-generated scene summaries</p>
      </ion-label>
      <ion-badge slot="end" color="primary">
        {{ getModelDisplayName(settings.sceneSummaryGeneration.selectedModel) }}
      </ion-badge>
    </ion-item>
    <div slot="content" class="accordion-content">
      <p class="section-description">
        Customize how the AI summarizes your scenes for context and navigation.
      </p>

      <ion-item>
        <ion-label>Creativity (Temperature)</ion-label>
        <ion-range
          [(ngModel)]="settings.sceneSummaryGeneration.temperature"
          (ngModelChange)="settingsChange.emit()"
          min="0.1"
          max="1.0"
          step="0.1"
          snaps="true"
          slot="end">
          <ion-label slot="start">0.1</ion-label>
          <ion-label slot="end">1.0</ion-label>
        </ion-range>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">AI Model for Scene Summary</ion-label>
        <div class="model-selection-container">
          <ng-select [(ngModel)]="settings.sceneSummaryGeneration.selectedModel"
                     [items]="combinedModels"
                     bindLabel="label"
                     bindValue="id"
                     [searchable]="true"
                     [clearable]="true"
                     [disabled]="modelsDisabled"
                     placeholder="Select model (empty = use global model)"
                     (ngModelChange)="settingsChange.emit()"
                     [loading]="loadingModels"
                     [virtualScroll]="true"
                     class="ng-select-custom"
                     appendTo="body">
            <ng-template ng-option-tmp let-item="item">
              <div class="model-option">
                <div class="model-option-header">
                  <ion-icon
                    [name]="getProviderIcon(item.provider)"
                    class="provider-icon"
                    [class.gemini]="item.provider === 'gemini'"
                    [class.openrouter]="item.provider === 'openrouter'"
                    [class.ollama]="item.provider === 'ollama'"
                    [class.claude]="item.provider === 'claude'"
                    [class.replicate]="item.provider === 'replicate'"
                    [title]="getProviderTooltip(item.provider)"></ion-icon>
                  <span class="model-label">{{ item.label }}</span>
                </div>
                <div class="model-option-details">
                  <span class="model-cost">Input: {{ item.costInputEur }} | Output: {{ item.costOutputEur }}</span>
                  <span class="model-context">Context: {{ formatContextLength(item.contextLength) }}</span>
                </div>
                <div class="model-description" *ngIf="item.description">{{ item.description }}</div>
              </div>
            </ng-template>
          </ng-select>
          <div class="model-info-small">
            <p *ngIf="modelLoadError" class="error-text">{{ modelLoadError }}</p>
            <p *ngIf="!modelLoadError && !settings.sceneSummaryGeneration.selectedModel" class="info-text">
              No model selected - the global model will be used
            </p>
            <p *ngIf="!modelLoadError && settings.sceneSummaryGeneration.selectedModel" class="info-text">
              Specific model for scene summary: {{ getModelDisplayName(settings.sceneSummaryGeneration.selectedModel) }}
            </p>
          </div>
        </div>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Additional Instructions (optional)</ion-label>
        <ion-textarea
          [(ngModel)]="settings.sceneSummaryGeneration.customInstruction"
          (ngModelChange)="settingsChange.emit()"
          placeholder="e.g. 'Focus on main plot' or 'Include character emotions'"
          rows="3"
          auto-grow="true">
        </ion-textarea>
      </ion-item>

      <ion-item>
        <ion-label>Use Custom Prompt</ion-label>
        <ion-toggle
          [(ngModel)]="settings.sceneSummaryGeneration.useCustomPrompt"
          (ngModelChange)="settingsChange.emit()"
          slot="end">
        </ion-toggle>
      </ion-item>

      <ion-item *ngIf="settings.sceneSummaryGeneration.useCustomPrompt">
        <ion-label position="stacked">
          Custom Prompt
          <p class="prompt-help">
            Available placeholders: {{ '{' }}sceneTitle{{ '}' }}, {{ '{' }}sceneContent{{ '}' }}, {{ '{' }}customInstruction{{ '}' }}, {{ '{' }}languageInstruction{{ '}' }}, {{ '{' }}truncatedNote{{ '}' }}, {{ '{' }}additionalInstructions{{ '}' }}
          </p>
        </ion-label>
        <ion-textarea
          [(ngModel)]="settings.sceneSummaryGeneration.customPrompt"
          (ngModelChange)="settingsChange.emit()"
          placeholder="Create a summary of the following scene..."
          rows="8"
          auto-grow="true">
        </ion-textarea>
      </ion-item>

      <ion-item *ngIf="settings.sceneSummaryGeneration.useCustomPrompt">
        <ion-button fill="outline" size="small" (click)="resetToDefaultSummaryPrompt()">
          Restore Default Prompt
        </ion-button>
      </ion-item>
    </div>
  </ion-accordion>

  <!-- Staging Notes Generation -->
  <ion-accordion value="staging-notes">
    <ion-item slot="header" lines="full">
      <ion-icon name="film-outline" slot="start"></ion-icon>
      <ion-label>
        <h3>Staging Notes Generation</h3>
        <p>Configure AI-generated staging notes</p>
      </ion-label>
      <ion-badge slot="end" color="primary">
        {{ getModelDisplayName(settings.stagingNotesGeneration.selectedModel) }}
      </ion-badge>
    </ion-item>
    <div slot="content" class="accordion-content">
      <p class="section-description">
        Customize how the AI extracts staging and blocking information from your scenes.
      </p>

      <ion-item>
        <ion-label>Creativity (Temperature)</ion-label>
        <ion-range
          [(ngModel)]="settings.stagingNotesGeneration.temperature"
          (ngModelChange)="settingsChange.emit()"
          min="0.1"
          max="1.0"
          step="0.1"
          snaps="true"
          slot="end">
          <ion-label slot="start">0.1</ion-label>
          <ion-label slot="end">1.0</ion-label>
        </ion-range>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">AI Model for Staging Notes</ion-label>
        <div class="model-selection-container">
          <ng-select [(ngModel)]="settings.stagingNotesGeneration.selectedModel"
                     [items]="combinedModels"
                     bindLabel="label"
                     bindValue="id"
                     [searchable]="true"
                     [clearable]="true"
                     [disabled]="modelsDisabled"
                     placeholder="Select model (empty = use global model)"
                     (ngModelChange)="settingsChange.emit()"
                     [loading]="loadingModels"
                     [virtualScroll]="true"
                     class="ng-select-custom"
                     appendTo="body">
            <ng-template ng-option-tmp let-item="item">
              <div class="model-option">
                <div class="model-option-header">
                  <ion-icon
                    [name]="getProviderIcon(item.provider)"
                    class="provider-icon"
                    [class.gemini]="item.provider === 'gemini'"
                    [class.openrouter]="item.provider === 'openrouter'"
                    [class.ollama]="item.provider === 'ollama'"
                    [class.claude]="item.provider === 'claude'"
                    [class.replicate]="item.provider === 'replicate'"
                    [title]="getProviderTooltip(item.provider)"></ion-icon>
                  <span class="model-label">{{ item.label }}</span>
                </div>
                <div class="model-option-details">
                  <span class="model-cost">Input: {{ item.costInputEur }} | Output: {{ item.costOutputEur }}</span>
                  <span class="model-context">Context: {{ formatContextLength(item.contextLength) }}</span>
                </div>
                <div class="model-description" *ngIf="item.description">{{ item.description }}</div>
              </div>
            </ng-template>
          </ng-select>
          <div class="model-info-small">
            <p *ngIf="modelLoadError" class="error-text">{{ modelLoadError }}</p>
            <p *ngIf="!modelLoadError && !settings.stagingNotesGeneration.selectedModel" class="info-text">
              No model selected - the global model will be used
            </p>
            <p *ngIf="!modelLoadError && settings.stagingNotesGeneration.selectedModel" class="info-text">
              Specific model for staging notes: {{ getModelDisplayName(settings.stagingNotesGeneration.selectedModel) }}
            </p>
          </div>
        </div>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">Additional Instructions (optional)</ion-label>
        <ion-textarea
          [(ngModel)]="settings.stagingNotesGeneration.customInstruction"
          (ngModelChange)="settingsChange.emit()"
          placeholder="e.g. 'Focus on character positions' or 'Include lighting details'"
          rows="3"
          auto-grow="true">
        </ion-textarea>
      </ion-item>

      <ion-item>
        <ion-label>Use Custom Prompt</ion-label>
        <ion-toggle
          [(ngModel)]="settings.stagingNotesGeneration.useCustomPrompt"
          (ngModelChange)="settingsChange.emit()"
          slot="end">
        </ion-toggle>
      </ion-item>

      <ion-item *ngIf="settings.stagingNotesGeneration.useCustomPrompt">
        <ion-label position="stacked">
          Custom Prompt
          <p class="prompt-help">
            Available placeholders: {{ '{' }}sceneContent{{ '}' }}, {{ '{' }}languageInstruction{{ '}' }}, {{ '{' }}customInstruction{{ '}' }}
          </p>
        </ion-label>
        <ion-textarea
          [(ngModel)]="settings.stagingNotesGeneration.customPrompt"
          (ngModelChange)="settingsChange.emit()"
          placeholder="Extract staging notes from the following scene..."
          rows="8"
          auto-grow="true">
        </ion-textarea>
      </ion-item>

      <ion-item *ngIf="settings.stagingNotesGeneration.useCustomPrompt">
        <ion-button fill="outline" size="small" (click)="resetToDefaultStagingNotesPrompt()">
          Restore Default Prompt
        </ion-button>
      </ion-item>
    </div>
  </ion-accordion>

  <!-- Beat Rewrite Favorites -->
  <ion-accordion value="rewrite-favorites">
    <ion-item slot="header" lines="full">
      <ion-icon name="sync-outline" slot="start"></ion-icon>
      <ion-label>
        <h3>Beat Rewrite</h3>
        <p>Quick-select models for text rewriting</p>
      </ion-label>
      <ion-badge slot="end" color="primary">
        {{ settings.favoriteModelLists?.rewrite?.length || 0 }} favorites
      </ion-badge>
    </ion-item>
    <div slot="content" class="accordion-content">
      <p class="section-description">
        Choose up to 6 models to surface as quick actions in the rewrite modal.
        The first model in the list will be selected by default.
      </p>
      <app-model-favorites-settings
        [favoriteIds]="settings.favoriteModelLists?.rewrite || []"
        [combinedModels]="combinedModels"
        [loadingModels]="loadingModels"
        [modelLoadError]="modelLoadError"
        [showCard]="false"
        (favoriteIdsChange)="onRewriteFavoritesChange($event)">
      </app-model-favorites-settings>
    </div>
  </ion-accordion>

</ion-accordion-group>
