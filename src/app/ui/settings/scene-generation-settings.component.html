<div class="scene-generation-settings">
  <div class="tab-header">
    <h2>Scene Generation from Outline</h2>
    <p>Configure how scenes are generated from your story outline</p>
  </div>

  <ion-accordion-group [multiple]="true" [value]="['output', 'context']" class="scene-gen-accordion">

    <!-- Output Settings -->
    <ion-accordion value="output">
      <ion-item slot="header" lines="full">
        <ion-icon name="options-outline" slot="start"></ion-icon>
        <ion-label>
          <h3>Output Settings</h3>
          <p>Word count and creativity controls</p>
        </ion-label>
        <ion-badge slot="end" color="primary">
          {{ settings.sceneGenerationFromOutline.wordCount }} words
        </ion-badge>
      </ion-item>
      <div slot="content" class="accordion-content">
        <div class="settings-group">
          <div class="setting-item">
            <div class="setting-header">
              <ion-label>
                <h4>Default Target Length</h4>
                <p>Target word count for generated scenes</p>
              </ion-label>
              <span class="value-display">{{ settings.sceneGenerationFromOutline.wordCount }} words</span>
            </div>
            <ion-range
              [(ngModel)]="settings.sceneGenerationFromOutline.wordCount"
              (ngModelChange)="settingsChange.emit()"
              min="200"
              max="5000"
              step="100"
              class="custom-range">
              <ion-label slot="start">200</ion-label>
              <ion-label slot="end">5000</ion-label>
            </ion-range>
          </div>

          <div class="setting-item">
            <div class="setting-header">
              <ion-label>
                <h4>Creativity (Temperature)</h4>
                <p>Higher values produce more creative, varied output</p>
              </ion-label>
              <span class="value-display">{{ settings.sceneGenerationFromOutline.temperature }}</span>
            </div>
            <ion-range
              [(ngModel)]="settings.sceneGenerationFromOutline.temperature"
              (ngModelChange)="settingsChange.emit()"
              min="0"
              max="1.5"
              step="0.1"
              snaps="true"
              class="custom-range">
              <ion-label slot="start">0</ion-label>
              <ion-label slot="end">1.5</ion-label>
            </ion-range>
          </div>
        </div>
      </div>
    </ion-accordion>

    <!-- Context Settings -->
    <ion-accordion value="context">
      <ion-item slot="header" lines="full">
        <ion-icon name="layers-outline" slot="start"></ion-icon>
        <ion-label>
          <h3>Context Settings</h3>
          <p>Control what information is included in generation</p>
        </ion-label>
        <ion-badge slot="end" [color]="getContextBadgeColor()">
          {{ getActiveContextCount() }} active
        </ion-badge>
      </ion-item>
      <div slot="content" class="accordion-content">
        <div class="settings-group">
          <ion-item class="toggle-item">
            <ion-label>
              <h4>Include Story Outline/Context</h4>
              <p>Provide story context for better continuity</p>
            </ion-label>
            <ion-toggle
              [(ngModel)]="settings.sceneGenerationFromOutline.includeStoryOutline"
              (ngModelChange)="settingsChange.emit()"
              slot="end">
            </ion-toggle>
          </ion-item>

          <ion-item class="toggle-item sub-item" *ngIf="settings.sceneGenerationFromOutline.includeStoryOutline">
            <ion-label>
              <h4>Use Full Text</h4>
              <p>Use complete text instead of summaries (uses more tokens)</p>
            </ion-label>
            <ion-toggle
              [(ngModel)]="settings.sceneGenerationFromOutline.useFullStoryContext"
              (ngModelChange)="settingsChange.emit()"
              slot="end">
            </ion-toggle>
          </ion-item>

          <ion-item class="toggle-item">
            <ion-label>
              <h4>Include Codex</h4>
              <p>Include character and world-building information</p>
            </ion-label>
            <ion-toggle
              [(ngModel)]="settings.sceneGenerationFromOutline.includeCodex"
              (ngModelChange)="settingsChange.emit()"
              slot="end">
            </ion-toggle>
          </ion-item>
        </div>
      </div>
    </ion-accordion>

    <!-- Custom Prompt Settings -->
    <ion-accordion value="custom">
      <ion-item slot="header" lines="full">
        <ion-icon name="code-outline" slot="start"></ion-icon>
        <ion-label>
          <h3>Custom Prompt</h3>
          <p>Additional instructions and prompt customization</p>
        </ion-label>
        <ion-badge slot="end" [color]="settings.sceneGenerationFromOutline.useCustomPrompt ? 'warning' : 'medium'">
          {{ settings.sceneGenerationFromOutline.useCustomPrompt ? 'Custom' : 'Default' }}
        </ion-badge>
      </ion-item>
      <div slot="content" class="accordion-content">
        <div class="settings-group">
          <div class="textarea-group">
            <ion-label position="stacked">
              <h4>Additional Instructions (optional)</h4>
              <p>Extra guidance for the AI during generation</p>
            </ion-label>
            <ion-textarea
              [(ngModel)]="settings.sceneGenerationFromOutline.customInstruction"
              (ngModelChange)="settingsChange.emit()"
              rows="3"
              [autoGrow]="true"
              placeholder="e.g., Maintain a noir tone; avoid explicit content"
              class="custom-textarea">
            </ion-textarea>
          </div>

          <ion-item class="toggle-item">
            <ion-label>
              <h4>Use Custom Prompt Template</h4>
              <p>Override the default prompt with your own template</p>
            </ion-label>
            <ion-toggle
              [(ngModel)]="settings.sceneGenerationFromOutline.useCustomPrompt"
              (ngModelChange)="settingsChange.emit()"
              slot="end">
            </ion-toggle>
          </ion-item>

          <div class="textarea-group" *ngIf="settings.sceneGenerationFromOutline.useCustomPrompt">
            <ion-label position="stacked">
              <h4>Custom Prompt Template</h4>
              <p class="prompt-help">
                Available placeholders:
                <code>{{ '{' }}storyTitle{{ '}' }}</code>,
                <code>{{ '{' }}systemMessage{{ '}' }}</code>,
                <code>{{ '{' }}codexEntries{{ '}' }}</code>,
                <code>{{ '{' }}storySoFar{{ '}' }}</code>,
                <code>{{ '{' }}sceneOutline{{ '}' }}</code>,
                <code>{{ '{' }}wordCount{{ '}' }}</code>,
                <code>{{ '{' }}languageInstruction{{ '}' }}</code>,
                <code>{{ '{' }}customInstruction{{ '}' }}</code>
              </p>
            </ion-label>
            <ion-textarea
              [(ngModel)]="settings.sceneGenerationFromOutline.customPrompt"
              (ngModelChange)="settingsChange.emit()"
              rows="12"
              [autoGrow]="true"
              class="custom-textarea code-textarea">
            </ion-textarea>
          </div>
        </div>
      </div>
    </ion-accordion>

  </ion-accordion-group>
</div>
