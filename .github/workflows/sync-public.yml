name: Sync to Public Repository

on:
  push:
    branches: [release]  # Only sync on release branch pushes
  workflow_dispatch: # Allow manual trigger

jobs:
  sync-public:
    runs-on: ubuntu-latest
    if: github.repository == 'MarcoDroll/creativewriter2' # Only run on private repo
    permissions:
      contents: read
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit_hash: ${{ steps.version.outputs.commit_hash }}
      commit_message: ${{ steps.version.outputs.commit_message }}
      build_date: ${{ steps.version.outputs.build_date }}
    
    steps:
      - name: Checkout private repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get full history
          token: ${{ secrets.PUBLIC_REPO_TOKEN }}

      - name: Setup Git and sync to public repository
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          
          echo "Syncing release branch to public repository..."
          git remote add public https://x-access-token:${GITHUB_TOKEN}@github.com/MarcoDroll/creativewriter-public.git
          
          # Store the original commit info before making changes
          ORIGINAL_COMMIT_MESSAGE=$(git log -1 --pretty=format:'%s')
          ORIGINAL_COMMIT_HASH=$(git rev-parse --short HEAD)
          echo "ORIGINAL_COMMIT_MESSAGE=$ORIGINAL_COMMIT_MESSAGE" >> $GITHUB_ENV
          echo "ORIGINAL_COMMIT_HASH=$ORIGINAL_COMMIT_HASH" >> $GITHUB_ENV
          
          # Create a temporary branch and filter files for public sync
          git checkout -b temp-public-sync
          
          # Copy the public docker-compose.yml to replace the private one
          if [ -f "docker-compose.public.yml" ]; then
            cp docker-compose.public.yml docker-compose.yml
            echo "âœ… Replaced docker-compose.yml with public version"
          fi
          
          # Copy the public Docker workflow file before removing .github
          mkdir -p .github-public/workflows
          if [ -f ".github/workflows/docker-public-images.yml" ]; then
            cp .github/workflows/docker-public-images.yml .github-public/workflows/docker-build.yml
            echo "âœ… Copied public Docker workflow"
          fi
          
          # Remove private development directories and files
          rm -rf .github/ || true  # Remove workflow files
          rm -rf .claude/ || true  # Remove Claude development files
          rm -rf .vscode/ || true  # Remove VS Code settings
          rm -rf .claudescreenshots/ || true  # Remove Claude screenshots
          rm -rf docs/ || true  # Exclude private docs from public sync
          rm -f docker-compose.public.yml || true  # Remove the public compose file itself
          
          # Move the public workflow back to .github
          if [ -d ".github-public" ]; then
            mv .github-public .github
            echo "âœ… Added public workflow files"
          fi
          
          # Add all changes and force push without creating a commit in history
          git add -A
          git commit --amend --no-edit  # Amend the current commit instead of creating new one
          
          git push public temp-public-sync:main --force
          echo "âœ… Successfully synced release branch to public repository main branch (without private development files)"

      - name: Generate version and release info
        id: version
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          
          # Generate new version using timestamp for uniqueness
          TIMESTAMP=$(date +"%Y%m%d%H%M")
          MAJOR_MINOR=$(echo $CURRENT_VERSION | cut -d. -f1-2)
          NEW_VERSION="${MAJOR_MINOR}.${TIMESTAMP}"
          
          # Use the preserved original commit info
          COMMIT_HASH="${ORIGINAL_COMMIT_HASH}"
          COMMIT_MESSAGE="${ORIGINAL_COMMIT_MESSAGE}"
          BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          # Set outputs
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "commit_message=$COMMIT_MESSAGE" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          
          echo "Generated version: v$NEW_VERSION"
          echo "Commit: $COMMIT_HASH - $COMMIT_MESSAGE"

  create-public-release:
    needs: sync-public
    runs-on: ubuntu-latest
    if: needs.sync-public.result == 'success'
    
    steps:
      - name: Trigger image builds in public repository
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          VERSION="${{ needs.sync-public.outputs.version }}"
          
          # Trigger the workflow in the public repository if it exists
          echo "Attempting to trigger Docker image builds in public repository..."
          
          # Check if the workflow exists and trigger it
          gh workflow run docker-build.yml \
            --repo MarcoDroll/creativewriter-public \
            --field version="v${VERSION}" \
            2>/dev/null || echo "Note: Could not trigger workflow (may not exist yet)"
      
      - name: Checkout for release notes
        uses: actions/checkout@v4
        with:
          ref: release
          sparse-checkout: RELEASE_NOTES.md
          sparse-checkout-cone-mode: false

      - name: Create release in public repository
        env:
          GITHUB_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          VERSION="${{ needs.sync-public.outputs.version }}"
          COMMIT_HASH="${{ needs.sync-public.outputs.commit_hash }}"
          BUILD_DATE="${{ needs.sync-public.outputs.build_date }}"

          # Check if RELEASE_NOTES.md exists and read it
          if [ -f "RELEASE_NOTES.md" ]; then
            echo "ðŸ“ Found RELEASE_NOTES.md, using prepared release notes"
            CUSTOM_NOTES=$(cat RELEASE_NOTES.md)
          else
            echo "âš ï¸ No RELEASE_NOTES.md found, using default notes"
            CUSTOM_NOTES="No detailed release notes provided for this release."
          fi

          # Write release notes to a temporary file to handle multiline content
          cat > /tmp/release_notes.md << RELEASE_EOF
## ðŸš€ Release v${VERSION}

### ðŸ“‹ Release Details
- **Version**: v${VERSION}
- **Build Date**: ${BUILD_DATE}
- **Source Commit**: ${COMMIT_HASH}

---

${CUSTOM_NOTES}

---

### ðŸ“¦ Docker Images
The following stable Docker images are available:

| Image | Pull Command |
|-------|--------------|
| Main Application | \`docker pull ghcr.io/marcodroll/creativewriter-public:stable\` |
| Proxy Service | \`docker pull ghcr.io/marcodroll/creativewriter-public-proxy:stable\` |
| Gemini Proxy | \`docker pull ghcr.io/marcodroll/creativewriter-public-gemini-proxy:stable\` |
| Nginx Reverse Proxy | \`docker pull ghcr.io/marcodroll/creativewriter-public-nginx:stable\` |
| CouchDB Database | \`docker pull ghcr.io/marcodroll/creativewriter-public-couchdb:stable\` |

### ðŸŽ¯ Quick Start
\`\`\`bash
# Download docker-compose.yml
curl -O https://raw.githubusercontent.com/MarcoDroll/creativewriter-public/main/docker-compose.yml

# Start the application
docker compose up -d

# Access at http://localhost:3080
\`\`\`

---
ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
RELEASE_EOF

          # Create the release in the public repository using the notes file
          gh release create "v${VERSION}" \
            --repo MarcoDroll/creativewriter-public \
            --title "v${VERSION}" \
            --notes-file /tmp/release_notes.md \
            --latest

          echo "âœ… Created release v${VERSION} in public repository"
          echo "ðŸ”— Release URL: https://github.com/MarcoDroll/creativewriter-public/releases/tag/v${VERSION}"

      - name: Create sync summary
        run: |
          echo "# ðŸ”„ Public Repository Sync Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Sync Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Private â†’ Public Sync**: âœ… Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Creation**: âœ… Successful" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Images**: ðŸ”„ Building (triggered by release)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ New Release" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: v${{ needs.sync-public.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release URL**: [v${{ needs.sync-public.outputs.version }}](https://github.com/MarcoDroll/creativewriter-public/releases/tag/v${{ needs.sync-public.outputs.version }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Docker Registry**: [GitHub Container Registry](https://github.com/MarcoDroll/creativewriter-public/pkgs/container/creativewriter-public)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŽ¯ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "The release will automatically trigger the stable Docker images workflow in the public repository." >> $GITHUB_STEP_SUMMARY
